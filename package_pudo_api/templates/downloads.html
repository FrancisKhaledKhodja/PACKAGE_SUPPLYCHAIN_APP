{% extends 'base.html' %}
{% block content %}
<div class="card">
  <h2 style="margin:0 0 8px; color:var(--muted)">Téléchargements</h2>
  <div id="files" class="section"></div>
</div>
<script>
(function(){
  const API = (path) => `${location.origin.replace(/:\\d+$/, ':5001')}/api${path}`; // ajustez si besoin
  const filesDiv = document.getElementById('files');

  function escapeHtml(s){return (s==null?'':String(s))
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

  function render(list){
    const keys = Object.keys(list);
    if (!keys.length){ filesDiv.innerHTML = '<div class="muted">Aucun fichier détecté</div>'; return; }
    const rows = keys.map(k => {
      const ok = !!list[k];
      const link = ok ? `<a href="${API('/downloads/'+encodeURIComponent(k))}" class="btn" style="display:inline-block; margin-top:6px">Télécharger</a>` : '<span class="muted">Indisponible</span>';
      return `<li style="margin:8px 0"><strong>${escapeHtml(k)}</strong><br/>${link}</li>`;
    }).join('');
    filesDiv.innerHTML = `<ul style="list-style:none; padding:0; margin:0">${rows}</ul>`;
  }

  fetch(API('/downloads/'))
    .then(r=>r.json())
    .then(render)
    .catch(()=>{ filesDiv.textContent = 'Erreur de chargement'; });
})();
</script>
{% endblock %}
