{% extends 'base.html' %}
{% block content %}
<div class="layout" style="font-size:1rem;">
  <main class="card">
    <h2 style="margin:0 0 8px; color:var(--muted)">Recherche stock (items)</h2>
    <form id="form-search" class="row" onsubmit="return false;">
      <input type="text" id="q" placeholder="Code article, libellé, famille, etc." style="flex:1" />
      <button id="btn-search" type="submit">Rechercher</button>
    </form>

    <div class="section"></div>
    <div id="results-meta" class="row" style="justify-content:space-between">
      <div id="results-count" class="muted"></div>
      <div></div>
    </div>
    <div class="card" style="margin-top:8px;">
      <div style="overflow:auto; max-height:65vh;">
        <table id="tbl-items">
          <thead><tr id="thead-row"></tr></thead>
          <tbody id="tbody-rows"></tbody>
        </table>
      </div>
    </div>
  </main>

  <aside class="card">
    <h2 style="margin:0 0 8px; color:var(--muted)">Détail de l’article</h2>
    <div id="details" class="card" style="max-height:78vh; overflow:auto;"></div>
  </aside>
</div>

<script>
(function(){
  const API = (path) => `/api${path}`;
  const form = document.getElementById('form-search');
  const input = document.getElementById('q');
  const theadRow = document.getElementById('thead-row');
  const tbody = document.getElementById('tbody-rows');
  const details = document.getElementById('details');
  const count = document.getElementById('results-count');
  let lastRows = [];
  let selectedIdx = -1;

  const displayCols = ['code_article','libelle_court_article'];

  function escapeHtml(s){return (s==null?'':String(s))
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

  function renderTable(columns, rows){
    // decide header columns
    const cols = displayCols.filter(c => columns.includes(c));
    theadRow.innerHTML = cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('');
    lastRows = rows || [];
    tbody.innerHTML = lastRows.map((r, idx)=>{
      const code = r.code_article || r.code || r.id_article || '';
      const tds = cols.map(c=>`<td>${escapeHtml(r[c])}</td>`).join('');
      return `<tr data-code="${escapeHtml(code)}" data-idx="${idx}" style="cursor:pointer">${tds}</tr>`;
    }).join('');
  }

  function renderDetailsPayload(payload){
    details.innerHTML = '';
    if (!payload) { details.textContent = 'Aucune donnée.'; return; }
    let item = payload.item || {};
    const manufacturers = Array.isArray(payload.manufacturers)? payload.manufacturers: [];
    const equivalents = Array.isArray(payload.equivalents)? payload.equivalents: [];

    function kv(obj){
      const rows = Object.entries(obj).map(([k,v])=>`<tr><th style="text-align:left; padding:6px; width:30%">${escapeHtml(k)}</th><td style="padding:6px;">${escapeHtml(v)}</td></tr>`).join('');
      return `<table style="width:100%; border-collapse:collapse">${rows}</table>`;
    }
    function tableFromArray(arr, title, emptyMessage){
      const items = Array.isArray(arr) ? arr : [];
      if (!items.length) {
        return `<div class="section"></div><div style="font-weight:600; margin-bottom:6px;">${escapeHtml(title)}</div><div class="card"><div class="muted" style="padding:8px 12px;">${escapeHtml(emptyMessage || (`Aucun ${title.toLowerCase()}`))}</div></div>`;
      }
      const cols = Array.from(items.reduce((s,o)=>{Object.keys(o||{}).forEach(k=>s.add(k)); return s;}, new Set()));
      const head = `<thead><tr>${cols.map(c=>`<th style="text-align:left; padding:6px">${escapeHtml(c)}</th>`).join('')}</tr></thead>`;
      const body = `<tbody>${items.map(o=>`<tr>${cols.map(c=>`<td style=\"padding:6px\">${escapeHtml(o[c])}</td>`).join('')}</tr>`).join('')}</tbody>`;
      return `<div class="section"></div><div style="font-weight:600; margin-bottom:6px;">${escapeHtml(title)}</div><div class="card"><div style="overflow:auto; max-height:40vh"><table style="width:100%; border-collapse:collapse">${head}${body}</table></div></div>`;
    }

    // If empty item from API, fallback to selected local row when available
    if (Object.keys(item).length === 0 && selectedIdx >= 0 && lastRows[selectedIdx]) {
      item = lastRows[selectedIdx];
    }
    if (Object.keys(item).length === 0 && manufacturers.length === 0 && equivalents.length === 0) {
      details.textContent = 'Aucune donnée pour cet article.';
      return;
    }
    details.innerHTML = `<div style=\"font-weight:600; margin-bottom:6px;\">Article</div>` + kv(item)
      + tableFromArray(manufacturers, 'Références fournisseurs', 'Aucune référence fournisseur trouvée pour cet article.')
      + tableFromArray(equivalents, 'Équivalences', 'Aucun article équivalent trouvé pour cet article.');
  }

  tbody.addEventListener('click', (e)=>{
    let tr = e.target; while (tr && tr.tagName !== 'TR') tr = tr.parentElement;
    if (!tr) return;
    tbody.querySelectorAll('tr').forEach(r=>r.style.background='');
    tr.style.background = 'rgba(255,255,255,0.06)';
    const code = tr.dataset.code || '';
    const idx = parseInt(tr.dataset.idx || '-1', 10);
    selectedIdx = idx;
    if (!code) {
      if (!isNaN(idx) && lastRows[idx]) {
        renderDetailsPayload({ item: lastRows[idx], manufacturers: [], equivalents: [] });
      } else {
        details.textContent = 'Aucun code détecté pour cette ligne.';
      }
      return;
    }
    details.textContent = 'Chargement...';
    fetch(API(`/items/${encodeURIComponent(code)}/details`))
      .then(r=>r.ok ? r.json() : Promise.reject(r.status))
      .then(renderDetailsPayload)
      .catch(()=>{
        if (!isNaN(idx) && lastRows[idx]) {
          renderDetailsPayload({ item: lastRows[idx], manufacturers: [], equivalents: [] });
        } else {
          details.textContent='Erreur de chargement du détail';
        }
      });
  });

  form.addEventListener('submit', ()=>{
    const body = { q: input.value||'', filters: {}, limit: 300 };
    fetch(API('/items/search'), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) })
      .then(r=>r.json())
      .then(data=>{
        const cols = data.columns || [];
        const rows = data.rows || [];
        count.textContent = `${rows.length} résultat(s)`;
        renderTable(cols, rows);
        details.textContent = '';
      })
      .catch(()=>{ count.textContent='Erreur de recherche'; tbody.innerHTML=''; });
  });

  (async ()=>{
    try {
      const url = new URL(window.location.href);
      const codeParam = (url.searchParams.get('code') || '').trim();
      if (!codeParam) return;

      input.value = codeParam;

      const body = { q: codeParam, filters: {}, limit: 300 };
      const res = await fetch(API('/items/search'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await res.json();
      const cols = data.columns || [];
      const rows = data.rows || [];
      count.textContent = `${rows.length} résultat(s)`;
      renderTable(cols, rows);

      const normalize = (v) => (v == null ? '' : String(v)).trim().toUpperCase();
      const target = normalize(codeParam);
      const idx = lastRows.findIndex(r => normalize((r || {}).code_article || (r || {}).code || (r || {}).id_article) === target);

      if (idx >= 0) {
        const tr = tbody.querySelector(`tr[data-idx="${idx}"]`);
        if (tr) {
          tr.click();
          return;
        }
      }

      details.textContent = 'Chargement...';
      fetch(API(`/items/${encodeURIComponent(codeParam)}/details`))
        .then(r=>r.ok ? r.json() : Promise.reject(r.status))
        .then(renderDetailsPayload)
        .catch(()=>{ details.textContent = 'Aucun résultat pour ce code.'; });
    } catch (e) {
      // ignore
    }
  })();
})();
</script>
{% endblock %}
