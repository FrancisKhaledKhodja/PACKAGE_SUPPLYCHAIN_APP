<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>DEMANDE CREATION OU MODIFICATION ARTICLE</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/article_request.css">
  <script src="js/api.js?v=4" defer></script>
</head>
<body>
  <div id="scapp-header"></div>

  <div class="card">
    <h2 class="article-request-title">Demande création ou modification article</h2>
    <div class="row article-request-row">
      <label for="request-type" class="muted article-request-label-180">Type de demande</label>
      <select id="request-type" name="request_type" class="article-request-control-wide">
        <option value="" selected disabled>Choisir un type de demande...</option>
        <option value="creation_articles">Création d'article(s)</option>
        <option value="modification_criticite">Modification d'une criticité</option>
        <option value="modification_achetable">Modifcation du statut achetable ou non achetable</option>
        <option value="declaration_equivalence">Déclaration d'une équivalence</option>
        <option value="passage_rebut">Demande de passage en REBUT</option>
      </select>
    </div>

    <div id="requester-section" class="section">
      <div class="row article-request-row">
        <label for="requester-firstname" class="muted article-request-label-180">Prénom</label>
        <input id="requester-firstname" name="requester_firstname" type="text" placeholder="Saisir votre prénom" class="article-request-control-wide" />
      </div>
      <div class="row article-request-row scapp-mt-05">
        <label for="requester-lastname" class="muted article-request-label-180">Nom</label>
        <input id="requester-lastname" name="requester_lastname" type="text" placeholder="Saisir votre nom" class="article-request-control-wide" />
      </div>
    </div>

    <div id="creation-section" class="section">
      <h3 class="article-request-subtitle">Création d'article(s)</h3>
      <div class="row article-request-row-wide">
        <span class="muted article-request-label-220">Mode de saisie</span>
        <label class="article-request-inline-radio">
          <input type="radio" name="creation-mode" id="creation-mode-form" value="form" checked />
          Formulaire
        </label>
        <label class="article-request-inline-radio">
          <input type="radio" name="creation-mode" id="creation-mode-excel" value="excel" />
          Feuille (type Excel)
        </label>
      </div>

      <div class="row article-request-actions">
        <button id="creation-add-row" type="button">Ajouter une ligne</button>
        <button id="creation-validate" type="button">Valider</button>
      </div>

      <div id="creation-excel-import" class="row">
        <button id="creation-template-download" type="button">Télécharger le modèle</button>
        <label class="muted article-request-inline-radio">
          Importer un fichier Excel
          <input id="creation-import-file" type="file" accept=".xlsx,.xlsm" />
        </label>
      </div>

      <div id="creation-feedback" class="muted"></div>

      <div id="creation-form">
        <div class="scapp-creation-form-grid">
          <div class="scapp-creation-form-row-2">
            <div class="scapp-creation-form-section" id="creation-form-ref-fab-section">
              <div class="scapp-creation-form-section-title">REFERENCE FABRICANT</div>
              <div class="help-tip scapp-mb-05">
                <div class="help-tip-content">
                  <div class="help-tip-text">
                    <strong>Étape 1 :</strong> renseigner le <strong>fournisseur</strong>, la <strong>référence fabricant</strong> (référence exacte du matériel chez le fournisseur) et le <strong>prix prévisionnel</strong> de l'article.
                  </div>
                </div>
              </div>
              <div class="scapp-creation-form-inline">
                <div class="scapp-creation-form-field">
                  <label class="muted">Fabricant</label>
                  <input id="creation-form-fabricant" type="text" placeholder="Fabricant" list="creation-form-fabricant-list" required />
                  <datalist id="creation-form-fabricant-list"></datalist>
                  <div id="creation-form-fabricant-new">nouveau fournisseur</div>
                </div>
                <div class="scapp-creation-form-field">
                  <label class="muted">Référence fabricant</label>
                  <input id="creation-form-ref-fab" type="text" placeholder="Référence fabricant (31 caractères conseillés)" required />
                  <div id="creation-form-ref-fab-counter" class="muted"></div>
                  <div id="creation-form-ref-fab-check" class="muted"></div>
                </div>
                <div class="scapp-creation-form-field scapp-field-narrow">
                  <label class="muted">Prix prévisionnel</label>
                  <input id="creation-form-prix-prev" type="number" step="0.01" min="0" placeholder="ex: 12.50" required />
                </div>
              </div>
            </div>
            <div class="scapp-creation-form-section" id="creation-form-famille-section">
              <div class="scapp-creation-form-section-title">FAMILLE ARTICLE</div>
              <div class="help-tip scapp-mb-05">
                <div class="help-tip-content">
                  <div class="help-tip-text">
                    <strong>Étape 2 :</strong> choisir <strong>TDF</strong> (le matériel est acheté par TDF) ou <strong>CLT</strong> (le matériel est mis à disposition de TDF par le client).
                  </div>
                </div>
              </div>
              <div class="scapp-creation-form-inline">
                <div class="scapp-creation-form-field">
                  <label class="muted">Article TDF ou CLT</label>
                  <select id="creation-form-article" required>
                    <option value="" selected disabled>Choisir...</option>
                    <option value="TDF">TDF</option>
                    <option value="CLT">CLT</option>
                  </select>
                </div>
                <div class="scapp-creation-form-field">
                  <label class="muted">Feuille de catalogue</label>
                  <select id="creation-form-feuille" required>
                    <option value="" selected disabled>Choisir...</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="scapp-creation-form-section" id="creation-form-libelles-section">
            <div class="scapp-creation-form-section-title">LIBELLE ARTICLE</div>
            <div class="scapp-creation-form-inline">
              <div class="scapp-creation-form-field scapp-field-wide">
                <label class="muted">Libellé court</label>
                <textarea id="creation-form-libelle-court" maxlength="120" rows="2" placeholder="MAJUSCULES sans accents (120 car. max)" required></textarea>
                <div id="creation-form-libelle-court-counter" class="muted"></div>
              </div>
              <div class="scapp-creation-form-field scapp-field-wide">
                <label class="muted">Libellé long</label>
                <textarea id="creation-form-libelle-long" maxlength="240" rows="3" placeholder="MAJUSCULES sans accents (240 car. max)" required></textarea>
                <div id="creation-form-libelle-long-counter" class="muted"></div>
              </div>
            </div>
          </div>
          <div class="scapp-creation-form-section" id="creation-form-cycles-section">
            <div class="scapp-creation-form-section-title">CYCLES / STATUT</div>
            <div class="scapp-creation-form-inline">
              <div class="scapp-creation-form-field">
                <label class="muted">Type article</label>
                <select id="creation-form-type" required>
                  <option value="" selected disabled>Choisir...</option>
                  <option value="VAREQ">VAREQ</option>
                  <option value="SOUSEN">SOUSEN</option>
                  <option value="COMPOS">COMPOS</option>
                </select>
              </div>
              <div class="scapp-creation-form-field scapp-field-narrow" id="creation-form-mnemo-wrap">
                <label class="muted">Mnémonique</label>
                <input id="creation-form-mnemo" type="text" placeholder="20 caractères max" />
              </div>
              <div class="scapp-creation-form-field">
                <label class="muted">Cycle de vie production</label>
                <select id="creation-form-cycle-prod" required>
                  <option value="" selected disabled>Choisir...</option>
                  <option value="EXPERTISE">EXPERTISE</option>
                  <option value="INSTALLABLE AVEC RESERVE">INSTALLABLE AVEC RESERVE</option>
                  <option value="INSTALLABLE SANS RESERVE">INSTALLABLE SANS RESERVE</option>
                </select>
              </div>
              <div class="scapp-creation-form-field">
                <label class="muted">Cycle de vie achat</label>
                <select id="creation-form-cycle-achat" required>
                  <option value="" selected disabled>Choisir...</option>
                  <option value="ACHETABLE">ACHETABLE</option>
                  <option value="NON ACHETABLE">NON ACHETABLE</option>
                </select>
              </div>
              <div class="scapp-creation-form-field">
                <label class="muted">Statut d'article</label>
                <select id="creation-form-statut" required>
                  <option value="" selected disabled>Choisir...</option>
                  <option value="N.Stk.Ach.">N.Stk.Ach.</option>
                  <option value="N.StkN.Ach">N.StkN.Ach</option>
                  <option value="Stk. Ach.">Stk. Ach.</option>
                  <option value="Stk. N.Ach">Stk. N.Ach</option>
                </select>
              </div>
              <div class="scapp-creation-form-field scapp-field-narrow">
                <label class="muted">Criticité</label>
                <select id="creation-form-criticite" required>
                  <option value="" selected disabled>Choisir...</option>
                  <option value="0">0</option>
                  <option value="2">2</option>
                  <option value="10">10</option>
                </select>
              </div>
              <div class="scapp-creation-form-field scapp-field-wide">
                <label class="muted">Commentaire technique</label>
                <textarea id="creation-form-comm-tech" rows="2" placeholder="Commentaire technique"></textarea>
              </div>
            </div>
          </div>

          <div class="scapp-creation-form-section" id="creation-form-logistique-section">
            <div class="scapp-creation-form-section-title">DIMENSIONS / LOGISTIQUE</div>
            <div class="scapp-creation-form-inline">
              <div class="scapp-creation-form-field scapp-field-narrow">
                <label class="muted">Poids (kg)</label>
                <input id="creation-form-poids" type="number" step="0.001" min="0" placeholder="ex: 1.250" />
              </div>
              <div class="scapp-creation-form-field scapp-field-narrow">
                <label class="muted">Longueur (m)</label>
                <input id="creation-form-long" type="number" step="0.001" min="0" placeholder="ex: 0.450" />
              </div>
              <div class="scapp-creation-form-field scapp-field-narrow">
                <label class="muted">Largeur (m)</label>
                <input id="creation-form-larg" type="number" step="0.001" min="0" placeholder="ex: 0.300" />
              </div>
              <div class="scapp-creation-form-field scapp-field-narrow">
                <label class="muted">Hauteur (m)</label>
                <input id="creation-form-haut" type="number" step="0.001" min="0" placeholder="ex: 0.120" />
              </div>
              <div class="scapp-creation-form-field scapp-field-narrow">
                <label class="muted">Article datacenter</label>
                <select id="creation-form-datacenter" required>
                  <option value="" selected disabled>Choisir...</option>
                  <option value="OUI">OUI</option>
                  <option value="NON">NON</option>
                </select>
              </div>
              <div class="scapp-creation-form-field scapp-field-narrow">
                <label class="muted">Article hors norme</label>
                <select id="creation-form-hors-norme">
                  <option value="" selected disabled>Choisir...</option>
                  <option value="OUI">OUI</option>
                  <option value="NON">NON</option>
                </select>
              </div>
              <div class="scapp-creation-form-field scapp-field-narrow">
                <label class="muted">Péremption</label>
                <select id="creation-form-peremption" required>
                  <option value="" selected disabled>Choisir...</option>
                  <option value="OUI">OUI</option>
                  <option value="NON">NON</option>
                </select>
              </div>
              <div class="scapp-creation-form-field scapp-field-narrow">
                <label class="muted">Retour production</label>
                <select id="creation-form-retour-prod">
                  <option value="" selected disabled>Choisir...</option>
                  <option value="OUI">OUI</option>
                  <option value="NON">NON</option>
                </select>
              </div>
            </div>
          </div>
          <div class="scapp-creation-form-row-2">
            <div class="scapp-creation-form-section" id="creation-form-md-section">
              <div class="scapp-creation-form-section-title">MATIERE DANGEREUSE</div>
              <div class="scapp-creation-form-inline">
                <div class="scapp-creation-form-field scapp-field-narrow">
                  <label class="muted">Matière dangereuse</label>
                  <select id="creation-form-mat-dang" required>
                    <option value="" selected disabled>Choisir...</option>
                    <option value="OUI">OUI</option>
                    <option value="NON">NON</option>
                  </select>
                </div>
                <div id="creation-form-md-details" class="scapp-creation-form-inline">
                  <div class="scapp-creation-form-field">
                    <label class="muted">Catégorie MD</label>
                    <select id="creation-form-cat-md">
                      <option value="" selected disabled>Choisir...</option>
                      <option value="Liquide inflammable (peintures, solvants…)">Liquide inflammable (peintures, solvants…)</option>
                      <option value="Aérosol inflammable">Aérosol inflammable</option>
                      <option value="Piles/Batteries Plomb">Piles/Batteries Plomb</option>
                      <option value="Piles/Batteries Plomb étanche">Piles/Batteries Plomb étanche</option>
                      <option value="Pile/Batterie Métal seule">Pile/Batterie Métal seule</option>
                      <option value="Pile/Batterie Métal avec/dans équipement">Pile/Batterie Métal avec/dans équipement</option>
                      <option value="Pile/Batterie Ionique seule">Pile/Batterie Ionique seule</option>
                      <option value="Pile/Batterie Ionique avec/dans équipement">Pile/Batterie Ionique avec/dans équipement</option>
                      <option value="Pile/Batterie Nickel">Pile/Batterie Nickel</option>
                      <option value="Matière dangereuse du point de vue de l'environnement (solide)">Matière dangereuse du point de vue de l'environnement (solide)</option>
                      <option value="Autres (à préciser)">Autres (à préciser)</option>
                    </select>
                  </div>
                  <div class="scapp-creation-form-field">
                    <label class="muted">Code ONU</label>
                    <input id="creation-form-code-onu" type="text" placeholder="Code ONU" />
                  </div>
                </div>
              </div>
            </div>
            <div class="scapp-creation-form-section" id="creation-form-conso-section">
              <div class="scapp-creation-form-section-title">CONSOMMABLE</div>
              <div class="scapp-creation-form-inline">
                <div class="scapp-creation-form-field scapp-field-narrow">
                  <label class="muted">Catalogue consommables</label>
                  <select id="creation-form-cat-conso-flag">
                    <option value="" selected disabled>Choisir...</option>
                    <option value="OUI">OUI</option>
                    <option value="NON">NON</option>
                  </select>
                </div>
                <div id="creation-form-conso-details" class="scapp-creation-form-inline">
                  <div class="scapp-creation-form-field">
                    <label class="muted">Catégorie consommables</label>
                    <select id="creation-form-cat-conso">
                      <option value="" selected disabled>Choisir...</option>
                      <option value="BASSE FREQ/COURANTS FAIBLES">BASSE FREQ/COURANTS FAIBLES</option>
                      <option value="CHAUFFAGE/VENTIL/CLIM">CHAUFFAGE/VENTIL/CLIM</option>
                      <option value="ENERGIE">ENERGIE</option>
                      <option value="HYGIENE/SECURITE">HYGIENE/SECURITE</option>
                      <option value="INFORMATIQUE">INFORMATIQUE</option>
                      <option value="KIT">KIT</option>
                      <option value="OPTIQUE">OPTIQUE</option>
                      <option value="OUTILLAGE/FOURNITURES">OUTILLAGE/FOURNITURES</option>
                      <option value="PYLONE/AERIEN">PYLONE/AERIEN</option>
                      <option value="RF">RF</option>
                    </select>
                  </div>
                  <div class="scapp-creation-form-field">
                    <label class="muted">Sous catégorie consommables</label>
                    <select id="creation-form-sous-cat-conso">
                      <option value="" selected disabled>Choisir...</option>
                      <option value="CABLE/CORDON">CABLE/CORDON</option>
                      <option value="CONNECTEUR">CONNECTEUR</option>
                      <option value="ADAPTATEUR/TRANSITION">ADAPTATEUR/TRANSITION</option>
                      <option value="VENTILATEUR">VENTILATEUR</option>
                      <option value="FILTRE">FILTRE</option>
                      <option value="PILES/BATTERIES/ALIM">PILES/BATTERIES/ALIM</option>
                      <option value="CONTACTEUR/DECLENCHEUR">CONTACTEUR/DECLENCHEUR</option>
                      <option value="PROTECTION">PROTECTION</option>
                      <option value="RACCORDEMENT">RACCORDEMENT</option>
                      <option value="ECLAIRAGE">ECLAIRAGE</option>
                      <option value="MISE A LA TERRE">MISE A LA TERRE</option>
                      <option value="IDENTIFICATION">IDENTIFICATION</option>
                      <option value="OUTILS">OUTILS</option>
                      <option value="ETANCHEITE/PROTECTION">ETANCHEITE/PROTECTION</option>
                      <option value="SECURITE/IDENTIFICATION">SECURITE/IDENTIFICATION</option>
                      <option value="FIXATION">FIXATION</option>
                      <option value="HYGIENE">HYGIENE</option>
                      <option value="ENERGIE">ENERGIE</option>
                      <option value="OUTIL ISOLE">OUTIL ISOLE</option>
                      <option value="ACCES">ACCES</option>
                      <option value="OPTIQUE">OPTIQUE</option>
                      <option value="CHAUFFAGE/VENTIL/CLIM">CHAUFFAGE/VENTIL/CLIM</option>
                      <option value="BATIMENT/ESPACESVERTS">BATIMENT/ESPACESVERTS</option>
                      <option value="IDENTIFICATION/SECURITE">IDENTIFICATION/SECURITE</option>
                      <option value="VISSERIE">VISSERIE</option>
                      <option value="MEMOIRES">MEMOIRES</option>
                      <option value="ROUTEUR/MODEM">ROUTEUR/MODEM</option>
                      <option value="EMETTEUR HARRIS">EMETTEUR HARRIS</option>
                      <option value="INTERFACE/RACCORD">INTERFACE/RACCORD</option>
                      <option value="JARRETIERE">JARRETIERE</option>
                      <option value="ATTENUATEUR">ATTENUATEUR</option>
                      <option value="SPLITTER">SPLITTER</option>
                      <option value="CONDITIONNEMENT/EMBALLAGE">CONDITIONNEMENT/EMBALLAGE</option>
                      <option value="INFORMATIQUE">INFORMATIQUE</option>
                      <option value="RF">RF</option>
                      <option value="AERIEN">AERIEN</option>
                      <option value="RECEPTIONSAT">RECEPTIONSAT</option>
                      <option value="CHARGE">CHARGE</option>
                      <option value="BRETELLES">BRETELLES</option>
                      <option value="REPARTITEUR">REPARTITEUR</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="muted article-request-hint">Pour saisir plusieurs articles, basculez en mode "Feuille (type Excel)".</div>
      </div>

      <div id="creation-excel">
        <div class="scapp-excel-wrap">
          <table id="creation-table" class="scapp-excel">
            <colgroup>
              <col class="scapp-col-w-220" />
              <col class="scapp-col-w-220" />
              <col class="scapp-col-w-140" />
              <col class="scapp-col-w-140" />
              <col class="scapp-col-w-150" />
              <col class="scapp-col-w-360" />
              <col class="scapp-col-w-520" />
              <col class="scapp-col-w-140" />
              <col class="scapp-col-w-160" />
              <col class="scapp-col-w-240" />
              <col class="scapp-col-w-160" />
              <col class="scapp-col-w-150" />
              <col class="scapp-col-w-110" />
              <col class="scapp-col-w-360" />
              <col class="scapp-col-w-110" />
              <col class="scapp-col-w-110" />
              <col class="scapp-col-w-110" />
              <col class="scapp-col-w-110" />
              <col class="scapp-col-w-150" />
              <col class="scapp-col-w-150" />
              <col class="scapp-col-w-130" />
              <col class="scapp-col-w-170" />
              <col class="scapp-col-w-170" />
              <col class="scapp-col-w-220" />
              <col class="scapp-col-w-140" />
              <col class="scapp-col-w-200" />
              <col class="scapp-col-w-240" />
              <col class="scapp-col-w-240" />
              <col class="scapp-col-w-110" />
            </colgroup>
            <thead>
              <tr>
                <th>fabricant</th>
                <th>reference_fabricant</th>
                <th>prix_previsionnel</th>
                <th>article_tdf_clt</th>
                <th>feuille_du_catalogue</th>
                <th>libelle_court</th>
                <th>libelle_long</th>
                <th>type_article</th>
                <th>mnemonique</th>
                <th>cycle_vie_production</th>
                <th>cycle_vie_achat</th>
                <th>statut_article</th>
                <th>criticite</th>
                <th>commentaire_technique</th>
                <th>poids_kg</th>
                <th>long_m</th>
                <th>larg_m</th>
                <th>haut_m</th>
                <th>article_datacenter</th>
                <th>article_hors_norme</th>
                <th>peremption</th>
                <th>retour_production</th>
                <th>matiere_dangereuse</th>
                <th>categorie_md</th>
                <th>code_onu</th>
                <th>catalogue_consommables</th>
                <th>categorie_consommables</th>
                <th>sous_categorie_consommables</th>
                <th>statut</th>
              </tr>
            </thead>
            <tbody id="creation-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="achetable-section" class="section">
      <h3 class="article-request-subtitle">Modification du statut achetable / non achetable</h3>
      <div class="row article-request-actions">
        <button id="achetable-add-row" type="button">Ajouter une ligne</button>
        <button id="achetable-validate" type="button" class="article-request-validate-fixed">Valider</button>
      </div>
      <div id="achetable-feedback" class="muted"></div>
      <div class="scapp-excel-wrap article-request-table-wrap">
        <table id="achetable-table" class="scapp-excel">
          <colgroup>
            <col class="scapp-col-w-120" />
            <col class="scapp-col-w-160" />
            <col class="scapp-col-w-180" />
            <col class="scapp-col-w-520" />
            <col class="scapp-col-w-170" />
            <col class="scapp-col-w-210" />
            <col class="scapp-col-w-340" />
            <col class="scapp-col-w-110" />
            <col class="scapp-col-w-110" />
          </colgroup>
          <thead>
            <tr>
              <th>code_article</th>
              <th>feuille_du_catalogue</th>
              <th>type_article</th>
              <th>libelle_article</th>
              <th>statut article</th>
              <th>nouveau statut article</th>
              <th>Cause(s) de la modification</th>
              <th>statut</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="achetable-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="criticite-section" class="section">
      <h3 class="article-request-subtitle">Modification d'une criticité</h3>
      <div class="row article-request-actions">
        <button id="criticite-add-row" type="button">Ajouter une ligne</button>
        <button id="criticite-validate" type="button" class="article-request-validate-fixed">Valider</button>
      </div>
      <div id="criticite-feedback" class="muted"></div>
      <div class="scapp-excel-wrap article-request-table-wrap">
        <table id="criticite-table" class="scapp-excel">
          <colgroup>
            <col class="scapp-col-w-120" />
            <col class="scapp-col-w-160" />
            <col class="scapp-col-w-180" />
            <col class="scapp-col-w-520" />
            <col class="scapp-col-w-110" />
            <col class="scapp-col-w-150" />
            <col class="scapp-col-w-340" />
            <col class="scapp-col-w-110" />
            <col class="scapp-col-w-110" />
          </colgroup>
          <thead>
            <tr>
              <th>code_article</th>
              <th>feuille_du_catalogue</th>
              <th>type_article</th>
              <th>libelle_article</th>
              <th>criticité article</th>
              <th>nouvelle criticite_article</th>
              <th>Cause(s) de la modification</th>
              <th>statut</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="criticite-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="equivalence-section" class="section">
      <h3 class="article-request-subtitle">Déclaration d'une équivalence</h3>
      <div class="row article-request-actions">
        <button id="equivalence-add-row" type="button">Ajouter une ligne</button>
        <button id="equivalence-validate" type="button" class="article-request-validate-fixed">Valider</button>
      </div>
      <div id="equivalence-feedback" class="muted"></div>
      <div class="scapp-excel-wrap article-request-table-wrap">
        <table id="equivalence-table" class="scapp-excel">
          <colgroup>
            <col class="scapp-col-w-130" />
            <col class="scapp-col-w-520" />
            <col class="scapp-col-w-160" />
            <col class="scapp-col-w-520" />
            <col class="scapp-col-w-220" />
            <col class="scapp-col-w-120" />
            <col class="scapp-col-w-90" />
            <col class="scapp-col-w-110" />
            <col class="scapp-col-w-110" />
          </colgroup>
          <thead>
            <tr>
              <th>code_article</th>
              <th>libelle_article</th>
              <th>code_equivalent</th>
              <th>libelle_article_equivalent</th>
              <th>type_equivalence</th>
              <th>reciprocite</th>
              <th>rang</th>
              <th>statut</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="equivalence-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="rebut-section" class="section">
      <h3 class="article-request-subtitle">Demande de passage en REBUT</h3>
      <div class="row article-request-actions">
        <button id="rebut-add-row" type="button">Ajouter une ligne</button>
        <button id="rebut-validate" type="button" class="article-request-validate-fixed">Valider</button>
      </div>
      <div id="rebut-feedback" class="muted"></div>
      <div class="scapp-excel-wrap article-request-table-wrap">
        <table id="rebut-table" class="scapp-excel">
          <colgroup>
            <col class="scapp-col-w-120" />
            <col class="scapp-col-w-520" />
            <col class="scapp-col-w-160" />
            <col class="scapp-col-w-180" />
            <col class="scapp-col-w-170" />
            <col class="scapp-col-w-110" />
            <col class="scapp-col-w-240" />
            <col class="scapp-col-w-200" />
            <col class="scapp-col-w-210" />
            <col class="scapp-col-w-90" />
            <col class="scapp-col-w-160" />
          </colgroup>
          <thead>
            <tr>
              <th>code_article</th>
              <th>libelle_article</th>
              <th>feuille_du_catalogue</th>
              <th>type_article</th>
              <th>statut_abrege_article</th>
              <th>criticite</th>
              <th>cycle_de_vie_de_production_pim</th>
              <th>cycle_de_vie_achat</th>
              <th>lieu_de_reparation_pim</th>
              <th>rma</th>
              <th>retour_production</th>
            </tr>
          </thead>
          <tbody id="rebut-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener("DOMContentLoaded", function () {
      const select = document.getElementById("request-type");
      const section = document.getElementById("requester-section");
      const firstname = document.getElementById("requester-firstname");
      const lastname = document.getElementById("requester-lastname");
      const criticiteSection = document.getElementById("criticite-section");
      const criticiteTbody = document.getElementById("criticite-tbody");
      const criticiteAddRowBtn = document.getElementById("criticite-add-row");
      const criticiteValidateBtn = document.getElementById("criticite-validate");
      const criticiteFeedback = document.getElementById("criticite-feedback");

      const creationSection = document.getElementById("creation-section");
      const creationForm = document.getElementById("creation-form");
      const creationExcel = document.getElementById("creation-excel");
      const creationModeForm = document.getElementById("creation-mode-form");
      const creationModeExcel = document.getElementById("creation-mode-excel");
      const creationTbody = document.getElementById("creation-tbody");
      const creationAddRowBtn = document.getElementById("creation-add-row");
      const creationValidateBtn = document.getElementById("creation-validate");
      const creationFeedback = document.getElementById("creation-feedback");
      const creationExcelImport = document.getElementById("creation-excel-import");
      const creationTemplateDownloadBtn = document.getElementById("creation-template-download");
      const creationImportFileInp = document.getElementById("creation-import-file");

      const achetableSection = document.getElementById("achetable-section");
      const achetableTbody = document.getElementById("achetable-tbody");
      const achetableAddRowBtn = document.getElementById("achetable-add-row");
      const achetableValidateBtn = document.getElementById("achetable-validate");
      const achetableFeedback = document.getElementById("achetable-feedback");

      const equivalenceSection = document.getElementById("equivalence-section");
      const equivalenceTbody = document.getElementById("equivalence-tbody");
      const equivalenceAddRowBtn = document.getElementById("equivalence-add-row");
      const equivalenceValidateBtn = document.getElementById("equivalence-validate");
      const equivalenceFeedback = document.getElementById("equivalence-feedback");

      const rebutSection = document.getElementById("rebut-section");
      const rebutTbody = document.getElementById("rebut-tbody");
      const rebutAddRowBtn = document.getElementById("rebut-add-row");
      const rebutValidateBtn = document.getElementById("rebut-validate");
      const rebutFeedback = document.getElementById("rebut-feedback");

      if (!select || !section || !firstname || !lastname) return;

      function norm(s) {
        return String(s || "").trim();
      }

      function hasRequester() {
        return !!(norm(firstname.value) && norm(lastname.value));
      }

      function toIsoLocal(d) {
        const pad = (n) => String(n).padStart(2, "0");
        const yyyy = d.getFullYear();
        const mm = pad(d.getMonth() + 1);
        const dd = pad(d.getDate());
        const hh = pad(d.getHours());
        const mi = pad(d.getMinutes());
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
      }

      function toUpperNoAccents(s) {
        const txt = String(s || "");
        const normed = txt.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        return normed.toUpperCase();
      }

      function isYes(v) {
        return norm(v).toUpperCase() === "OUI";
      }

      function setCreationMode(mode) {
        if (!creationForm || !creationExcel) return;
        const m = mode === "excel" ? "excel" : "form";
        creationForm.style.display = m === "form" ? "block" : "none";
        creationExcel.style.display = m === "excel" ? "block" : "none";
        if (creationExcelImport) {
          creationExcelImport.style.display = m === "excel" ? "flex" : "none";
        }
        if (m === "excel") {
          ensureOneCreationRow();
        } else {
          updateCreationFormMdVisibility();
          updateCreationFormConsoVisibility();
        }
      }

      function _ensureSelectOption(sel, value) {
        if (!sel) return;
        const v = norm(value);
        if (!v) return;
        const has = Array.from(sel.options || []).some((o) => String(o.value) === v);
        if (!has) {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        }
      }

      async function importCreationRowsFromXlsx(file) {
        if (!file) return;
        if (typeof API !== "function") return;
        if (!creationTbody) return;

        if (creationFeedback) {
          creationFeedback.textContent = "Import Excel en cours...";
        }

        try {
          const fd = new FormData();
          fd.append("file", file);
          const resp = await fetch(API("/downloads/demandes/creation_articles_parse_xlsx"), {
            method: "POST",
            credentials: "include",
            body: fd,
          });
          const data = await resp.json().catch(() => null);
          if (!resp.ok || !data || !data.ok) {
            const err = data && data.error ? String(data.error) : "import_failed";
            if (creationFeedback) creationFeedback.textContent = "Erreur import Excel: " + err;
            return;
          }

          const rows = Array.isArray(data.rows) ? data.rows : [];
          if (!rows.length) {
            if (creationFeedback) creationFeedback.textContent = "Aucune ligne trouvée dans le fichier.";
            return;
          }

          creationTbody.innerHTML = "";

          for (const r of rows) {
            const row = createCreationRow();

            row.fabricant.inp.value = toUpperNoAccents(r.fabricant || "");
            row.refFab.inp.value = toUpperNoAccents(r.reference_fabricant || "");
            row.prixPrev.inp.value = String(r.prix_previsionnel || "");

            _ensureSelectOption(row.article.sel, r.article_tdf_clt);
            row.article.sel.value = norm(r.article_tdf_clt);

            _ensureSelectOption(row.feuille.sel, r.feuille_du_catalogue);
            row.feuille.sel.value = norm(r.feuille_du_catalogue);

            row.libCourt.inp.value = toUpperNoAccents(r.libelle_court || "").slice(0, 120);
            row.libLong.inp.value = toUpperNoAccents(r.libelle_long || "").slice(0, 240);

            _ensureSelectOption(row.typeArticle.sel, r.type_article);
            row.typeArticle.sel.value = norm(r.type_article);

            row.mnemo.inp.value = toUpperNoAccents(r.mnemonique || "").slice(0, 20);

            _ensureSelectOption(row.cycleProd.sel, r.cycle_vie_production);
            row.cycleProd.sel.value = norm(r.cycle_vie_production);

            _ensureSelectOption(row.cycleAchat.sel, r.cycle_vie_achat);
            row.cycleAchat.sel.value = norm(r.cycle_vie_achat);

            _ensureSelectOption(row.statut.sel, r.statut_article);
            row.statut.sel.value = norm(r.statut_article);

            _ensureSelectOption(row.criticite.sel, r.criticite);
            row.criticite.sel.value = norm(r.criticite);

            row.commTech.inp.value = String(r.commentaire_technique || "");
            row.poids.inp.value = String(r.poids_kg || "");
            row.longM.inp.value = String(r.long_m || "");
            row.largM.inp.value = String(r.larg_m || "");
            row.hautM.inp.value = String(r.haut_m || "");

            _ensureSelectOption(row.datacenter.sel, r.article_datacenter);
            row.datacenter.sel.value = norm(r.article_datacenter);

            _ensureSelectOption(row.horsNorme.sel, r.article_hors_norme);
            row.horsNorme.sel.value = norm(r.article_hors_norme);

            _ensureSelectOption(row.peremption.sel, r.peremption);
            row.peremption.sel.value = norm(r.peremption);

            _ensureSelectOption(row.retourProd.sel, r.retour_production);
            row.retourProd.sel.value = norm(r.retour_production);

            _ensureSelectOption(row.matDang.sel, r.matiere_dangereuse);
            row.matDang.sel.value = norm(r.matiere_dangereuse);

            _ensureSelectOption(row.catMd.sel, r.categorie_md);
            row.catMd.sel.value = norm(r.categorie_md);
            row.codeOnu.inp.value = toUpperNoAccents(r.code_onu || "");

            _ensureSelectOption(row.catConsoFlag.sel, r.catalogue_consommables);
            row.catConsoFlag.sel.value = norm(r.catalogue_consommables);

            _ensureSelectOption(row.catConso.sel, r.categorie_consommables);
            row.catConso.sel.value = norm(r.categorie_consommables);

            _ensureSelectOption(row.sousCatConso.sel, r.sous_categorie_consommables);
            row.sousCatConso.sel.value = norm(r.sous_categorie_consommables);

            creationTbody.appendChild(row.tr);

            row.typeArticle.sel.dispatchEvent(new Event("change", { bubbles: true }));
            row.matDang.sel.dispatchEvent(new Event("change", { bubbles: true }));
            row.catMd.sel.dispatchEvent(new Event("change", { bubbles: true }));
            row.catConsoFlag.sel.dispatchEvent(new Event("change", { bubbles: true }));
          }

          if (creationFeedback) {
            creationFeedback.textContent = `${rows.length} ligne(s) importée(s).`;
          }
        } catch (e) {
          if (creationFeedback) creationFeedback.textContent = "Erreur import Excel.";
        }
      }

      let creationFabricants = [];
      async function loadFabricantsOptions() {
        if (typeof API !== "function") return;
        try {
          const resp = await fetch(API("/items/meta/fabricants"), { credentials: "include" });
          if (!resp.ok) return;
          const data = await resp.json().catch(() => null);
          const values = data && Array.isArray(data.values) ? data.values : [];
          creationFabricants = (values || []).map((v) => String(v || "").trim()).filter((v) => v);

          const dl = document.getElementById("creation-form-fabricant-list");
          if (dl) {
            dl.innerHTML = creationFabricants
              .map((v) => `<option value="${String(v).replace(/"/g, "&quot;")}"></option>`)
              .join("\n");
          }

          updateCreationFabricantIsNew();
        } catch (e) {
          // ignore
        }
      }

      function updateCreationFabricantIsNew() {
        const inp = document.getElementById("creation-form-fabricant");
        const badge = document.getElementById("creation-form-fabricant-new");
        if (!inp || !badge) return;
        const v = norm(inp.value);
        if (!v) {
          badge.style.display = "none";
          return;
        }
        const vUp = v.toUpperCase();
        const isKnown = (creationFabricants || []).some((x) => String(x || "").trim().toUpperCase() === vUp);
        badge.style.display = isKnown ? "none" : "block";
      }

      function setSelectOptions(selectEl, values) {
        if (!selectEl) return;
        const current = selectEl.value;
        const options = [`<option value="" selected disabled>Choisir...</option>`]
          .concat((values || []).map((v) => `<option value="${String(v).replace(/"/g, "&quot;")}">${String(v)}</option>`));
        selectEl.innerHTML = options.join("\n");
        if (current && (values || []).includes(current)) {
          selectEl.value = current;
        }
      }

      async function loadFeuillesDuCatalogueOptions() {
        if (typeof API !== "function") return;
        try {
          const resp = await fetch(API("/items/meta/feuilles_du_catalogue"), { credentials: "include" });
          if (!resp.ok) return;
          const data = await resp.json().catch(() => null);
          const values = data && Array.isArray(data.values) ? data.values : [];
          setSelectOptions(document.getElementById("creation-form-feuille"), values);

          if (creationTbody) {
            creationTbody.querySelectorAll("tr").forEach((tr) => {
              const sel = tr.querySelector("td:nth-child(2) select");
              setSelectOptions(sel, values);
            });
          }
        } catch (e) {
          return;
        }
      }

      function createCriticiteRow() {
        const tr = document.createElement("tr");

        const tdCode = document.createElement("td");
        tdCode.style.padding = "6px";
        const inputCode = document.createElement("input");
        inputCode.type = "text";
        inputCode.placeholder = "Code article";
        inputCode.setAttribute("data-required", "1");
        inputCode.className = "scapp-excel-input";
        tdCode.appendChild(inputCode);

        const tdFeuille = document.createElement("td");
        tdFeuille.style.padding = "6px";
        const inputFeuille = document.createElement("input");
        inputFeuille.type = "text";
        inputFeuille.readOnly = true;
        inputFeuille.className = "scapp-excel-input";
        tdFeuille.appendChild(inputFeuille);

        const tdType = document.createElement("td");
        tdType.style.padding = "6px";
        const inputType = document.createElement("input");
        inputType.type = "text";
        inputType.readOnly = true;
        inputType.className = "scapp-excel-input";
        tdType.appendChild(inputType);

        const tdLib = document.createElement("td");
        tdLib.style.padding = "6px";
        const inputLib = document.createElement("input");
        inputLib.type = "text";
        inputLib.readOnly = true;
        inputLib.className = "scapp-excel-input";
        tdLib.appendChild(inputLib);

        const tdCrit = document.createElement("td");
        tdCrit.style.padding = "6px";
        const inputCrit = document.createElement("input");
        inputCrit.type = "text";
        inputCrit.readOnly = true;
        inputCrit.className = "scapp-excel-input";
        tdCrit.appendChild(inputCrit);

        const tdNewCrit = document.createElement("td");
        tdNewCrit.style.padding = "6px";
        const inputNewCrit = document.createElement("select");
        inputNewCrit.setAttribute("data-required", "1");
        inputNewCrit.className = "scapp-excel-select";
        inputNewCrit.innerHTML = `
          <option value="" selected disabled>Choisir...</option>
          <option value="0">0</option>
          <option value="2">2</option>
          <option value="10">10</option>
        `;
        tdNewCrit.appendChild(inputNewCrit);

        const tdCause = document.createElement("td");
        tdCause.style.padding = "6px";
        const inputCause = document.createElement("input");
        inputCause.type = "text";
        inputCause.placeholder = "Cause(s)";
        inputCause.setAttribute("data-required", "1");
        inputCause.className = "scapp-excel-input";
        tdCause.appendChild(inputCause);

        const tdStatus = document.createElement("td");
        tdStatus.style.padding = "6px";
        const status = document.createElement("span");
        status.className = "muted";
        status.textContent = "";
        tdStatus.appendChild(status);

        const tdActions = document.createElement("td");
        tdActions.className = "scapp-excel-actions";
        const btnDel = document.createElement("button");
        btnDel.type = "button";
        btnDel.textContent = "Supprimer";
        tdActions.appendChild(btnDel);

        tr.appendChild(tdCode);
        tr.appendChild(tdFeuille);
        tr.appendChild(tdType);
        tr.appendChild(tdLib);
        tr.appendChild(tdCrit);
        tr.appendChild(tdNewCrit);
        tr.appendChild(tdCause);
        tr.appendChild(tdStatus);
        tr.appendChild(tdActions);

        async function fillFromCode() {
          const code = norm(inputCode.value).toUpperCase();
          inputCode.value = code;
          inputFeuille.value = "";
          inputType.value = "";
          inputLib.value = "";
          inputCrit.value = "";
          status.textContent = "";
          status.style.color = "";

          if (!code) return;
          if (typeof API !== "function") {
            status.textContent = "API indisponible";
            status.style.color = "#f87171";
            return;
          }
          try {
            status.textContent = "Chargement...";
            const resp = await fetch(API(`/items/${encodeURIComponent(code)}/details`), { credentials: "include" });
            if (!resp.ok) {
              status.textContent = "Code inconnu / API";
              status.style.color = "#f87171";
              return;
            }
            const data = await resp.json().catch(() => null);
            const item = data && typeof data === "object" ? data.item : null;
            if (!item || typeof item !== "object") {
              status.textContent = "Code inconnu";
              status.style.color = "#f87171";
              return;
            }

            const feuille = item.feuille_du_catalogue || item.feuille_de_catalogue || item.feuille_catalogue || "";
            const typeArticle = item.type_article || item.type || "";
            const lib = item.libelle_court_article || item.libelle_article || item.libelle || "";
            const crit = item.criticite_pim || item.criticite || item.criticite_article || "";
            inputFeuille.value = feuille ? String(feuille) : "";
            inputType.value = typeArticle ? String(typeArticle) : "";
            inputLib.value = lib ? String(lib) : "";
            inputCrit.value = crit ? String(crit) : "";
            status.textContent = "OK";
            status.style.color = "#34d399";
          } catch (e) {
            status.textContent = "Erreur";
            status.style.color = "#f87171";
            return;
          }
        }

        let debounceTimer = null;
        function scheduleFillFromCode() {
          if (debounceTimer) {
            clearTimeout(debounceTimer);
          }
          debounceTimer = setTimeout(() => {
            debounceTimer = null;
            fillFromCode();
          }, 350);
        }

        inputCode.addEventListener("change", fillFromCode);
        inputCode.addEventListener("blur", fillFromCode);
        inputCode.addEventListener("input", scheduleFillFromCode);
        inputCode.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            fillFromCode();
          }
        });

        btnDel.addEventListener("click", () => {
          tr.remove();
        });

        return {
          tr,
          inputCode,
          inputFeuille,
          inputType,
          inputLib,
          inputCrit,
          inputNewCrit,
          inputCause,
          status,
        };
      }

      function ensureOneRow() {
        if (!criticiteTbody) return;
        if (criticiteTbody.querySelectorAll("tr").length > 0) return;
        const row = createCriticiteRow();
        criticiteTbody.appendChild(row.tr);
      }

      function createAchetableRow() {
        const tr = document.createElement("tr");

        const tdCode = document.createElement("td");
        tdCode.style.padding = "6px";
        const inputCode = document.createElement("input");
        inputCode.type = "text";
        inputCode.placeholder = "Code article";
        inputCode.setAttribute("data-required", "1");
        inputCode.className = "scapp-excel-input";
        tdCode.appendChild(inputCode);

        const tdFeuille = document.createElement("td");
        tdFeuille.style.padding = "6px";
        const inputFeuille = document.createElement("input");
        inputFeuille.type = "text";
        inputFeuille.readOnly = true;
        inputFeuille.className = "scapp-excel-input";
        tdFeuille.appendChild(inputFeuille);

        const tdType = document.createElement("td");
        tdType.style.padding = "6px";
        const inputType = document.createElement("input");
        inputType.type = "text";
        inputType.readOnly = true;
        inputType.className = "scapp-excel-input";
        tdType.appendChild(inputType);

        const tdLib = document.createElement("td");
        tdLib.style.padding = "6px";
        const inputLib = document.createElement("input");
        inputLib.type = "text";
        inputLib.readOnly = true;
        inputLib.className = "scapp-excel-input";
        tdLib.appendChild(inputLib);

        const tdStatusArticle = document.createElement("td");
        tdStatusArticle.style.padding = "6px";
        const inputStatusArticle = document.createElement("input");
        inputStatusArticle.type = "text";
        inputStatusArticle.readOnly = true;
        inputStatusArticle.className = "scapp-excel-input";
        tdStatusArticle.appendChild(inputStatusArticle);

        const tdNewStatus = document.createElement("td");
        tdNewStatus.style.padding = "6px";
        const inputNewStatus = document.createElement("select");
        inputNewStatus.setAttribute("data-required", "1");
        inputNewStatus.className = "scapp-excel-select";
        inputNewStatus.innerHTML = `
          <option value="" selected disabled>Choisir...</option>
          <option value="Stk. N.Ach">Stk. N.Ach</option>
          <option value="Mort">Mort</option>
          <option value="N.StkN.Ach">N.StkN.Ach</option>
          <option value="Stk. Ach">Stk. Ach</option>
          <option value="N.StkAch.">N.StkAch.</option>
        `;
        tdNewStatus.appendChild(inputNewStatus);

        const tdCause = document.createElement("td");
        tdCause.style.padding = "6px";
        const inputCause = document.createElement("input");
        inputCause.type = "text";
        inputCause.placeholder = "Cause(s)";
        inputCause.setAttribute("data-required", "1");
        inputCause.className = "scapp-excel-input";
        tdCause.appendChild(inputCause);

        const tdStatus = document.createElement("td");
        tdStatus.style.padding = "6px";
        const status = document.createElement("span");
        status.className = "muted";
        status.textContent = "";
        tdStatus.appendChild(status);

        const tdActions = document.createElement("td");
        tdActions.className = "scapp-excel-actions";
        const btnDel = document.createElement("button");
        btnDel.type = "button";
        btnDel.textContent = "Supprimer";
        tdActions.appendChild(btnDel);

        tr.appendChild(tdCode);
        tr.appendChild(tdFeuille);
        tr.appendChild(tdType);
        tr.appendChild(tdLib);
        tr.appendChild(tdStatusArticle);
        tr.appendChild(tdNewStatus);
        tr.appendChild(tdCause);
        tr.appendChild(tdStatus);
        tr.appendChild(tdActions);

        async function fillFromCode() {
          const code = norm(inputCode.value).toUpperCase();
          inputCode.value = code;
          inputFeuille.value = "";
          inputType.value = "";
          inputLib.value = "";
          inputStatusArticle.value = "";
          status.textContent = "";
          status.style.color = "";

          if (!code) return;
          if (typeof API !== "function") {
            status.textContent = "API indisponible";
            status.style.color = "#f87171";
            return;
          }
          try {
            status.textContent = "Chargement...";
            const resp = await fetch(API(`/items/${encodeURIComponent(code)}/details`), { credentials: "include" });
            if (!resp.ok) {
              status.textContent = "Code inconnu / API";
              status.style.color = "#f87171";
              return;
            }
            const data = await resp.json().catch(() => null);
            const item = data && typeof data === "object" ? data.item : null;
            if (!item || typeof item !== "object") {
              status.textContent = "Code inconnu";
              status.style.color = "#f87171";
              return;
            }

            const feuille = item.feuille_du_catalogue || item.feuille_de_catalogue || item.feuille_catalogue || "";
            const typeArticle = item.type_article || item.type || "";
            const lib = item.libelle_court_article || item.libelle_article || item.libelle || "";
            const statutAbrege = item.statut_abrege_article || item.statut || "";
            inputFeuille.value = feuille ? String(feuille) : "";
            inputType.value = typeArticle ? String(typeArticle) : "";
            inputLib.value = lib ? String(lib) : "";
            inputStatusArticle.value = statutAbrege ? String(statutAbrege) : "";
            status.textContent = "OK";
            status.style.color = "#34d399";
          } catch (e) {
            status.textContent = "Erreur";
            status.style.color = "#f87171";
            return;
          }
        }

        let debounceTimer = null;
        function scheduleFillFromCode() {
          if (debounceTimer) {
            clearTimeout(debounceTimer);
          }
          debounceTimer = setTimeout(() => {
            debounceTimer = null;
            fillFromCode();
          }, 350);
        }

        inputCode.addEventListener("change", fillFromCode);
        inputCode.addEventListener("blur", fillFromCode);
        inputCode.addEventListener("input", scheduleFillFromCode);
        inputCode.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            fillFromCode();
          }
        });

        btnDel.addEventListener("click", () => {
          tr.remove();
        });

        return {
          tr,
          inputCode,
          inputFeuille,
          inputType,
          inputLib,
          inputStatusArticle,
          inputNewStatus,
          inputCause,
          status,
        };
      }

      function ensureOneAchetableRow() {
        if (!achetableTbody) return;
        if (achetableTbody.querySelectorAll("tr").length > 0) return;
        const row = createAchetableRow();
        achetableTbody.appendChild(row.tr);
      }

      function createEquivalenceRow() {
        const tr = document.createElement("tr");

        const tdCode = document.createElement("td");
        tdCode.style.padding = "6px";
        const inputCode = document.createElement("input");
        inputCode.type = "text";
        inputCode.placeholder = "Code article";
        inputCode.setAttribute("data-required", "1");
        inputCode.className = "scapp-excel-input";
        tdCode.appendChild(inputCode);

        const tdLib = document.createElement("td");
        tdLib.style.padding = "6px";
        const inputLib = document.createElement("input");
        inputLib.type = "text";
        inputLib.readOnly = true;
        inputLib.className = "scapp-excel-input";
        tdLib.appendChild(inputLib);

        const tdEqCode = document.createElement("td");
        tdEqCode.style.padding = "6px";
        const inputEqCode = document.createElement("input");
        inputEqCode.type = "text";
        inputEqCode.placeholder = "Code équivalent";
        inputEqCode.setAttribute("data-required", "1");
        inputEqCode.className = "scapp-excel-input";
        tdEqCode.appendChild(inputEqCode);

        const tdEqLib = document.createElement("td");
        tdEqLib.style.padding = "6px";
        const inputEqLib = document.createElement("input");
        inputEqLib.type = "text";
        inputEqLib.readOnly = true;
        inputEqLib.className = "scapp-excel-input";
        tdEqLib.appendChild(inputEqLib);

        const tdType = document.createElement("td");
        tdType.style.padding = "6px";
        const inputType = document.createElement("select");
        inputType.setAttribute("data-required", "1");
        inputType.className = "scapp-excel-select";
        inputType.innerHTML = `
          <option value="" selected disabled>Choisir...</option>
          <option value="substitution">substitution</option>
          <option value="substitution d'article">substitution d'article</option>
        `;
        tdType.appendChild(inputType);

        const tdRecip = document.createElement("td");
        tdRecip.style.padding = "6px";
        const inputRecip = document.createElement("select");
        inputRecip.setAttribute("data-required", "1");
        inputRecip.className = "scapp-excel-select";
        inputRecip.innerHTML = `
          <option value="" selected disabled>Choisir...</option>
          <option value="OUI">OUI</option>
          <option value="NON">NON</option>
        `;
        tdRecip.appendChild(inputRecip);

        const tdRang = document.createElement("td");
        tdRang.style.padding = "6px";
        const inputRang = document.createElement("input");
        inputRang.type = "number";
        inputRang.min = "1";
        inputRang.placeholder = "Rang";
        inputRang.setAttribute("data-required", "1");
        inputRang.className = "scapp-excel-input";
        tdRang.appendChild(inputRang);

        const tdStatus = document.createElement("td");
        tdStatus.style.padding = "6px";
        const status = document.createElement("span");
        status.className = "muted";
        status.textContent = "";
        tdStatus.appendChild(status);

        const tdActions = document.createElement("td");
        tdActions.className = "scapp-excel-actions";
        const btnDel = document.createElement("button");
        btnDel.type = "button";
        btnDel.textContent = "Supprimer";
        tdActions.appendChild(btnDel);

        tr.appendChild(tdCode);
        tr.appendChild(tdLib);
        tr.appendChild(tdEqCode);
        tr.appendChild(tdEqLib);
        tr.appendChild(tdType);
        tr.appendChild(tdRecip);
        tr.appendChild(tdRang);
        tr.appendChild(tdStatus);
        tr.appendChild(tdActions);

        async function fillLibelleFromCode(which) {
          const isEq = which === "eq";
          const codeInput = isEq ? inputEqCode : inputCode;
          const libInput = isEq ? inputEqLib : inputLib;

          const code = norm(codeInput.value).toUpperCase();
          codeInput.value = code;
          libInput.value = "";
          status.textContent = "";
          status.style.color = "";

          if (!code) return;
          if (typeof API !== "function") {
            status.textContent = "API indisponible";
            status.style.color = "#f87171";
            return;
          }
          try {
            status.textContent = "Chargement...";
            const resp = await fetch(API(`/items/${encodeURIComponent(code)}/details`), { credentials: "include" });
            if (!resp.ok) {
              status.textContent = "Code inconnu / API";
              status.style.color = "#f87171";
              return;
            }
            const data = await resp.json().catch(() => null);
            const item = data && typeof data === "object" ? data.item : null;
            if (!item || typeof item !== "object") {
              status.textContent = "Code inconnu";
              status.style.color = "#f87171";
              return;
            }
            const lib = item.libelle_court_article || item.libelle_article || item.libelle || "";
            libInput.value = lib ? String(lib) : "";
            status.textContent = "OK";
            status.style.color = "#34d399";
          } catch (e) {
            status.textContent = "Erreur";
            status.style.color = "#f87171";
            return;
          }
        }

        let debounceTimerCode = null;
        function scheduleFillCode() {
          if (debounceTimerCode) {
            clearTimeout(debounceTimerCode);
          }
          debounceTimerCode = setTimeout(() => {
            debounceTimerCode = null;
            fillLibelleFromCode("src");
          }, 350);
        }

        let debounceTimerEq = null;
        function scheduleFillEq() {
          if (debounceTimerEq) {
            clearTimeout(debounceTimerEq);
          }
          debounceTimerEq = setTimeout(() => {
            debounceTimerEq = null;
            fillLibelleFromCode("eq");
          }, 350);
        }

        inputCode.addEventListener("change", () => fillLibelleFromCode("src"));
        inputCode.addEventListener("blur", () => fillLibelleFromCode("src"));
        inputCode.addEventListener("input", scheduleFillCode);
        inputCode.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            fillLibelleFromCode("src");
          }
        });

        inputEqCode.addEventListener("change", () => fillLibelleFromCode("eq"));
        inputEqCode.addEventListener("blur", () => fillLibelleFromCode("eq"));
        inputEqCode.addEventListener("input", scheduleFillEq);
        inputEqCode.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            fillLibelleFromCode("eq");
          }
        });

        btnDel.addEventListener("click", () => {
          tr.remove();
        });

        return {
          tr,
          inputCode,
          inputLib,
          inputEqCode,
          inputEqLib,
          inputType,
          inputRecip,
          inputRang,
          status,
        };
      }

      function ensureOneEquivalenceRow() {
        if (!equivalenceTbody) return;
        if (equivalenceTbody.querySelectorAll("tr").length > 0) return;
        const row = createEquivalenceRow();
        equivalenceTbody.appendChild(row.tr);
      }

      function createRebutRow() {
        const tr = document.createElement("tr");

        const tdCode = document.createElement("td");
        tdCode.style.padding = "6px";
        const inputCode = document.createElement("input");
        inputCode.type = "text";
        inputCode.placeholder = "Code article";
        inputCode.setAttribute("data-required", "1");
        inputCode.className = "scapp-excel-input";
        tdCode.appendChild(inputCode);

        const makeRo = () => {
          const td = document.createElement("td");
          td.style.padding = "6px";
          const inp = document.createElement("input");
          inp.type = "text";
          inp.readOnly = true;
          inp.className = "scapp-excel-input";
          td.appendChild(inp);
          return { td, inp };
        };

        const roLib = makeRo();
        const roFeuille = makeRo();
        const roType = makeRo();
        const roStatut = makeRo();
        const roCrit = makeRo();
        const roCycleProd = makeRo();
        const roCycleAchat = makeRo();
        const roLieuRepar = makeRo();
        const roRma = makeRo();
        const roRetourProd = makeRo();

        tr.appendChild(tdCode);
        tr.appendChild(roLib.td);
        tr.appendChild(roFeuille.td);
        tr.appendChild(roType.td);
        tr.appendChild(roStatut.td);
        tr.appendChild(roCrit.td);
        tr.appendChild(roCycleProd.td);
        tr.appendChild(roCycleAchat.td);
        tr.appendChild(roLieuRepar.td);
        tr.appendChild(roRma.td);
        tr.appendChild(roRetourProd.td);

        async function fillFromCode() {
          const code = norm(inputCode.value).toUpperCase();
          inputCode.value = code;
          roLib.inp.value = "";
          roFeuille.inp.value = "";
          roType.inp.value = "";
          roStatut.inp.value = "";
          roCrit.inp.value = "";
          roCycleProd.inp.value = "";
          roCycleAchat.inp.value = "";
          roLieuRepar.inp.value = "";
          roRma.inp.value = "";
          roRetourProd.inp.value = "";

          if (!code) return;
          if (typeof API !== "function") {
            if (rebutFeedback) rebutFeedback.textContent = "API indisponible";
            return;
          }

          try {
            const resp = await fetch(API(`/items/${encodeURIComponent(code)}/details`), { credentials: "include" });
            if (!resp.ok) {
              if (rebutFeedback) rebutFeedback.textContent = "Code article inconnu / API";
              return;
            }
            const data = await resp.json().catch(() => null);
            const item = data && typeof data === "object" ? data.item : null;
            if (!item || typeof item !== "object") {
              if (rebutFeedback) rebutFeedback.textContent = "Code article inconnu";
              return;
            }

            const feuille = item.feuille_du_catalogue || item.feuille_de_catalogue || item.feuille_catalogue || "";
            const typeArticle = item.type_article || item.type || "";
            const lib = item.libelle_court_article || item.libelle_article || item.libelle || "";
            const statutAbrege = item.statut_abrege_article || item.statut || "";
            const crit = item.criticite_pim || item.criticite || item.criticite_article || "";
            const cycleProd = item.cycle_de_vie_de_production_pim || item.cycle_vie_production_pim || item.cycle_de_vie_de_production || "";
            const cycleAchat = item.cycle_de_vie_achat || item.cycle_vie_achat || "";
            const lieuRepar = item.lieu_de_reparation_pim || item.lieu_reparation_pim || item.lieu_de_reparation || "";
            const rma = item.rma || "";
            const retourProd = item.retour_production || item.retour_prod || "";

            roLib.inp.value = lib ? String(lib) : "";
            roFeuille.inp.value = feuille ? String(feuille) : "";
            roType.inp.value = typeArticle ? String(typeArticle) : "";
            roStatut.inp.value = statutAbrege ? String(statutAbrege) : "";
            roCrit.inp.value = crit ? String(crit) : "";
            roCycleProd.inp.value = cycleProd ? String(cycleProd) : "";
            roCycleAchat.inp.value = cycleAchat ? String(cycleAchat) : "";
            roLieuRepar.inp.value = lieuRepar ? String(lieuRepar) : "";
            roRma.inp.value = rma ? String(rma) : "";
            roRetourProd.inp.value = retourProd ? String(retourProd) : "";
          } catch (e) {
            if (rebutFeedback) rebutFeedback.textContent = "Erreur lors du chargement";
          }
        }

        let debounceTimer = null;
        function scheduleFillFromCode() {
          if (debounceTimer) {
            clearTimeout(debounceTimer);
          }
          debounceTimer = setTimeout(() => {
            debounceTimer = null;
            fillFromCode();
          }, 350);
        }

        inputCode.addEventListener("change", fillFromCode);
        inputCode.addEventListener("blur", fillFromCode);
        inputCode.addEventListener("input", scheduleFillFromCode);
        inputCode.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            fillFromCode();
          }
        });

        return { tr, inputCode };
      }

      function ensureOneRebutRow() {
        if (!rebutTbody) return;
        if (rebutTbody.querySelectorAll("tr").length > 0) return;
        const row = createRebutRow();
        rebutTbody.appendChild(row.tr);
      }

      function createCreationRow() {
        const tr = document.createElement("tr");

        const makeTdInput = (opts) => {
          const td = document.createElement("td");
          td.style.padding = "6px";
          const inp = document.createElement("input");
          inp.type = opts && opts.type ? opts.type : "text";
          if (opts && opts.placeholder) inp.placeholder = opts.placeholder;
          if (opts && opts.required) inp.setAttribute("data-required", "1");
          if (opts && opts.maxLen) inp.maxLength = String(opts.maxLen);
          if (opts && opts.min) inp.min = String(opts.min);
          if (opts && opts.step) inp.step = String(opts.step);
          inp.className = "scapp-excel-input";
          td.appendChild(inp);
          return { td, inp };
        };

        const makeTdSelect = (opts) => {
          const td = document.createElement("td");
          td.style.padding = "6px";
          const sel = document.createElement("select");
          if (opts && opts.required) sel.setAttribute("data-required", "1");
          sel.className = "scapp-excel-select";
          sel.innerHTML = opts && opts.html ? opts.html : `<option value="" selected disabled>Choisir...</option>`;
          td.appendChild(sel);
          return { td, sel };
        };

        const fabricant = makeTdInput({ placeholder: "Fabricant", required: true });
        const refFab = makeTdInput({ placeholder: "Réf fabricant", required: true });
        const prixPrev = makeTdInput({ type: "number", step: "0.01", min: "0", required: true });

        const article = makeTdSelect({ required: true, html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="TDF">TDF</option>
          <option value="CLT">CLT</option>
        ` });
        const feuille = makeTdSelect({ required: true, html: `
          <option value="" selected disabled>Choisir...</option>
        ` });
        const libCourt = makeTdInput({ placeholder: "Libellé court", required: true, maxLen: 120 });
        const libLong = makeTdInput({ placeholder: "Libellé long", required: true, maxLen: 240 });
        const typeArticle = makeTdSelect({ required: true, html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="VAREQ">VAREQ</option>
          <option value="SOUSEN">SOUSEN</option>
          <option value="COMPOS">COMPOS</option>
        ` });
        const mnemo = makeTdInput({ placeholder: "Mnémonique", maxLen: 20 });
        const cycleProd = makeTdSelect({ required: true, html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="EXPERTISE">EXPERTISE</option>
          <option value="INSTALLABLE AVEC RESERVE">INSTALLABLE AVEC RESERVE</option>
          <option value="INSTALLABLE SANS RESERVE">INSTALLABLE SANS RESERVE</option>
        ` });
        const cycleAchat = makeTdSelect({ required: true, html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="ACHETABLE">ACHETABLE</option>
          <option value="NON ACHETABLE">NON ACHETABLE</option>
        ` });
        const statut = makeTdSelect({ required: true, html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="N.Stk.Ach.">N.Stk.Ach.</option>
          <option value="N.StkN.Ach">N.StkN.Ach</option>
          <option value="Stk. Ach.">Stk. Ach.</option>
          <option value="Stk. N.Ach">Stk. N.Ach</option>
        ` });
        const criticite = makeTdSelect({ required: true, html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="0">0</option>
          <option value="2">2</option>
          <option value="10">10</option>
        ` });
        const commTech = makeTdInput({ placeholder: "Commentaire technique" });
        const poids = makeTdInput({ type: "number", step: "0.001", min: "0" });
        const longM = makeTdInput({ type: "number", step: "0.001", min: "0" });
        const largM = makeTdInput({ type: "number", step: "0.001", min: "0" });
        const hautM = makeTdInput({ type: "number", step: "0.001", min: "0" });
        const datacenter = makeTdSelect({ required: true, html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="OUI">OUI</option>
          <option value="NON">NON</option>
        ` });
        const horsNorme = makeTdSelect({ html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="OUI">OUI</option>
          <option value="NON">NON</option>
        ` });
        const peremption = makeTdSelect({ required: true, html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="OUI">OUI</option>
          <option value="NON">NON</option>
        ` });
        const retourProd = makeTdSelect({ html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="OUI">OUI</option>
          <option value="NON">NON</option>
        ` });
        const matDang = makeTdSelect({ required: true, html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="OUI">OUI</option>
          <option value="NON">NON</option>
        ` });
        const catMd = makeTdSelect({ html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="Liquide inflammable (peintures, solvants…)">Liquide inflammable (peintures, solvants…)</option>
          <option value="Aérosol inflammable">Aérosol inflammable</option>
          <option value="Piles/Batteries Plomb">Piles/Batteries Plomb</option>
          <option value="Piles/Batteries Plomb étanche">Piles/Batteries Plomb étanche</option>
          <option value="Pile/Batterie Métal seule">Pile/Batterie Métal seule</option>
          <option value="Pile/Batterie Métal avec/dans équipement">Pile/Batterie Métal avec/dans équipement</option>
          <option value="Pile/Batterie Ionique seule">Pile/Batterie Ionique seule</option>
          <option value="Pile/Batterie Ionique avec/dans équipement">Pile/Batterie Ionique avec/dans équipement</option>
          <option value="Pile/Batterie Nickel">Pile/Batterie Nickel</option>
          <option value="Matière dangereuse du point de vue de l'environnement (solide)">Matière dangereuse du point de vue de l'environnement (solide)</option>
          <option value="Autres (à préciser)">Autres (à préciser)</option>
        ` });
        const codeOnu = makeTdInput({ placeholder: "Code ONU" });
        const catConsoFlag = makeTdSelect({ html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="OUI">OUI</option>
          <option value="NON">NON</option>
        ` });
        const catConso = makeTdSelect({ html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="BASSE FREQ/COURANTS FAIBLES">BASSE FREQ/COURANTS FAIBLES</option>
          <option value="CHAUFFAGE/VENTIL/CLIM">CHAUFFAGE/VENTIL/CLIM</option>
          <option value="ENERGIE">ENERGIE</option>
          <option value="HYGIENE/SECURITE">HYGIENE/SECURITE</option>
          <option value="INFORMATIQUE">INFORMATIQUE</option>
          <option value="KIT">KIT</option>
          <option value="OPTIQUE">OPTIQUE</option>
          <option value="OUTILLAGE/FOURNITURES">OUTILLAGE/FOURNITURES</option>
          <option value="PYLONE/AERIEN">PYLONE/AERIEN</option>
          <option value="RF">RF</option>
        ` });
        const sousCatConso = makeTdSelect({ html: `
          <option value="" selected disabled>Choisir...</option>
          <option value="CABLE/CORDON">CABLE/CORDON</option>
          <option value="CONNECTEUR">CONNECTEUR</option>
          <option value="ADAPTATEUR/TRANSITION">ADAPTATEUR/TRANSITION</option>
          <option value="VENTILATEUR">VENTILATEUR</option>
          <option value="ALIM/CHARGEUR">ALIM/CHARGEUR</option>
          <option value="MONTAGE">MONTAGE</option>
          <option value="SOUND">SOUND</option>
          <option value="FILTRE">FILTRE</option>
          <option value="PILES/BATTERIES/ALIM">PILES/BATTERIES/ALIM</option>
          <option value="CONTACTEUR/DECLENCHEUR">CONTACTEUR/DECLENCHEUR</option>
          <option value="PROTECTION">PROTECTION</option>
          <option value="RACCORDEMENT">RACCORDEMENT</option>
          <option value="ECLAIRAGE">ECLAIRAGE</option>
          <option value="MISE A LA TERRE">MISE A LA TERRE</option>
          <option value="IDENTIFICATION">IDENTIFICATION</option>
          <option value="OUTILS">OUTILS</option>
          <option value="ETANCHEITE/PROTECTION">ETANCHEITE/PROTECTION</option>
          <option value="SECURITE/IDENTIFICATION">SECURITE/IDENTIFICATION</option>
          <option value="FIXATION">FIXATION</option>
          <option value="HYGIENE">HYGIENE</option>
          <option value="ENERGIE">ENERGIE</option>
          <option value="OUTIL ISOLE">OUTIL ISOLE</option>
          <option value="ACCES">ACCES</option>
          <option value="OPTIQUE">OPTIQUE</option>
          <option value="CHAUFFAGE/VENTIL/CLIM">CHAUFFAGE/VENTIL/CLIM</option>
          <option value="BATIMENT/ESPACESVERTS">BATIMENT/ESPACESVERTS</option>
          <option value="IDENTIFICATION/SECURITE">IDENTIFICATION/SECURITE</option>
          <option value="VISSERIE">VISSERIE</option>
          <option value="MEMOIRES">MEMOIRES</option>
          <option value="ROUTEUR/MODEM">ROUTEUR/MODEM</option>
          <option value="EMETTEUR HARRIS">EMETTEUR HARRIS</option>
          <option value="INTERFACE/RACCORD">INTERFACE/RACCORD</option>
          <option value="JARRETIERE">JARRETIERE</option>
          <option value="ATTENUATEUR">ATTENUATEUR</option>
          <option value="SPLITTER">SPLITTER</option>
          <option value="CONDITIONNEMENT/EMBALLAGE">CONDITIONNEMENT/EMBALLAGE</option>
          <option value="INFORMATIQUE">INFORMATIQUE</option>
          <option value="RF">RF</option>
          <option value="AERIEN">AERIEN</option>
          <option value="RECEPTIONSAT">RECEPTIONSAT</option>
          <option value="CHARGE">CHARGE</option>
          <option value="BRETELLES">BRETELLES</option>
          <option value="REPARTITEUR">REPARTITEUR</option>
        ` });

        const tdStatus = document.createElement("td");
        tdStatus.style.padding = "6px";
        const status = document.createElement("span");
        status.className = "muted";
        status.textContent = "";
        tdStatus.appendChild(status);

        tr.appendChild(fabricant.td);
        tr.appendChild(refFab.td);
        tr.appendChild(prixPrev.td);
        tr.appendChild(article.td);
        tr.appendChild(feuille.td);
        tr.appendChild(libCourt.td);
        tr.appendChild(libLong.td);
        tr.appendChild(typeArticle.td);
        tr.appendChild(mnemo.td);
        tr.appendChild(cycleProd.td);
        tr.appendChild(cycleAchat.td);
        tr.appendChild(statut.td);
        tr.appendChild(criticite.td);
        tr.appendChild(commTech.td);
        tr.appendChild(poids.td);
        tr.appendChild(longM.td);
        tr.appendChild(largM.td);
        tr.appendChild(hautM.td);
        tr.appendChild(datacenter.td);
        tr.appendChild(horsNorme.td);
        tr.appendChild(peremption.td);
        tr.appendChild(retourProd.td);
        tr.appendChild(matDang.td);
        tr.appendChild(catMd.td);
        tr.appendChild(codeOnu.td);
        tr.appendChild(catConsoFlag.td);
        tr.appendChild(catConso.td);
        tr.appendChild(sousCatConso.td);
        tr.appendChild(tdStatus);

        function enforceTextRules() {
          libCourt.inp.value = toUpperNoAccents(libCourt.inp.value).slice(0, 120);
          libLong.inp.value = toUpperNoAccents(libLong.inp.value).slice(0, 240);
          mnemo.inp.value = toUpperNoAccents(mnemo.inp.value).slice(0, 20);
          fabricant.inp.value = toUpperNoAccents(fabricant.inp.value);
          refFab.inp.value = toUpperNoAccents(refFab.inp.value);
        }

        function applyMnemoRequired() {
          const t = norm(typeArticle.sel.value);
          const req = !!t && t !== "COMPOS";
          mnemo.inp.required = req;
          if (!req) {
            mnemo.inp.value = "";
          }
        }

        function applyConditionalRequired() {
          const mdYes = isYes(matDang.sel.value);
          catMd.sel.required = mdYes;
          codeOnu.inp.required = mdYes;
          const consoYes = isYes(catConsoFlag.sel.value);
          catConso.sel.required = consoYes;
          sousCatConso.sel.required = consoYes;
        }

        function applyMdOnuMapping() {
          const onuByCat = {
            "Liquide inflammable (peintures, solvants…)": "1263",
            "Aérosol inflammable": "1950",
            "Piles/Batteries Plomb": "2794",
            "Piles/Batteries Plomb étanche": "2800",
            "Pile/Batterie Métal seule": "3090",
            "Pile/Batterie Métal avec/dans équipement": "3091",
            "Pile/Batterie Ionique seule": "3480",
            "Pile/Batterie Ionique avec/dans équipement": "3481",
            "Pile/Batterie Nickel": "3496",
            "Matière dangereuse du point de vue de l'environnement (solide)": "3077",
          };

          const mdYes = isYes(matDang.sel.value);
          if (!mdYes) {
            codeOnu.inp.value = "";
            codeOnu.inp.readOnly = false;
            return;
          }

          const catVal = norm(catMd.sel.value);
          const onuMapped = onuByCat[catVal];
          if (onuMapped) {
            codeOnu.inp.value = onuMapped;
            codeOnu.inp.readOnly = true;
          } else {
            codeOnu.inp.readOnly = false;
            if (!catVal) {
              codeOnu.inp.value = "";
            }
          }
        }

        [libCourt.inp, libLong.inp, mnemo.inp, fabricant.inp, refFab.inp].forEach((inp) => {
          inp.addEventListener("blur", enforceTextRules);
        });
        typeArticle.sel.addEventListener("change", applyMnemoRequired);
        matDang.sel.addEventListener("change", applyConditionalRequired);
        matDang.sel.addEventListener("change", applyMdOnuMapping);
        catMd.sel.addEventListener("change", applyMdOnuMapping);
        catConsoFlag.sel.addEventListener("change", applyConditionalRequired);

        applyConditionalRequired();
        applyMnemoRequired();
        applyMdOnuMapping();

        return {
          tr,
          article,
          feuille,
          libCourt,
          libLong,
          typeArticle,
          cycleProd,
          statut,
          cycleAchat,
          commTech,
          poids,
          longM,
          largM,
          hautM,
          datacenter,
          horsNorme,
          peremption,
          matDang,
          catMd,
          codeOnu,
          catConsoFlag,
          catConso,
          sousCatConso,
          retourProd,
          prixPrev,
          criticite,
          mnemo,
          fabricant,
          refFab,
          status,
        };
      }

      function ensureOneCreationRow() {
        if (!creationTbody) return;
        if (creationTbody.querySelectorAll("tr").length > 0) return;
        const row = createCreationRow();
        creationTbody.appendChild(row.tr);
      }

      function updateVisibility() {
        const hasSelection = !!(select.value && String(select.value).trim());
        section.style.display = hasSelection ? "block" : "none";
        firstname.required = hasSelection;
        lastname.required = hasSelection;

        const showCreation = hasSelection && select.value === "creation_articles" && hasRequester();
        if (creationSection) {
          creationSection.style.display = showCreation ? "block" : "none";
          if (showCreation) {
            const mode = creationModeExcel && creationModeExcel.checked ? "excel" : "form";
            setCreationMode(mode);
          }
        }

        const showCriticite = hasSelection && select.value === "modification_criticite" && hasRequester();
        if (criticiteSection) {
          criticiteSection.style.display = showCriticite ? "block" : "none";
          if (showCriticite) ensureOneRow();
        }

        const showAchetable = hasSelection && select.value === "modification_achetable" && hasRequester();
        if (achetableSection) {
          achetableSection.style.display = showAchetable ? "block" : "none";
          if (showAchetable) ensureOneAchetableRow();
        }

        const showEquivalence = hasSelection && select.value === "declaration_equivalence" && hasRequester();
        if (equivalenceSection) {
          equivalenceSection.style.display = showEquivalence ? "block" : "none";
          if (showEquivalence) ensureOneEquivalenceRow();
        }

        const showRebut = hasSelection && select.value === "passage_rebut" && hasRequester();
        if (rebutSection) {
          rebutSection.style.display = showRebut ? "block" : "none";
          if (showRebut) ensureOneRebutRow();
        }

        if (criticiteFeedback) {
          if (hasSelection && select.value === "modification_criticite" && !hasRequester()) {
            criticiteFeedback.textContent = "Veuillez renseigner votre prénom et votre nom pour continuer.";
          } else {
            criticiteFeedback.textContent = "";
          }
        }

        if (achetableFeedback) {
          if (hasSelection && select.value === "modification_achetable" && !hasRequester()) {
            achetableFeedback.textContent = "Veuillez renseigner votre prénom et votre nom pour continuer.";
          } else {
            achetableFeedback.textContent = "";
          }
        }

        if (equivalenceFeedback) {
          if (hasSelection && select.value === "declaration_equivalence" && !hasRequester()) {
            equivalenceFeedback.textContent = "Veuillez renseigner votre prénom et votre nom pour continuer.";
          } else {
            equivalenceFeedback.textContent = "";
          }
        }

        if (rebutFeedback) {
          if (hasSelection && select.value === "passage_rebut" && !hasRequester()) {
            rebutFeedback.textContent = "Veuillez renseigner votre prénom et votre nom pour continuer.";
          } else if (hasSelection && select.value === "creation_articles" && !hasRequester()) {
            rebutFeedback.textContent = "";
          } else if (!showRebut) {
            rebutFeedback.textContent = "";
          } else {
            rebutFeedback.textContent = "";
          }
        }

        if (creationFeedback) {
          if (hasSelection && select.value === "creation_articles" && !hasRequester()) {
            creationFeedback.textContent = "Veuillez renseigner votre prénom et votre nom pour continuer.";
          } else {
            creationFeedback.textContent = "";
          }
        }

        if (criticiteTbody) {
          criticiteTbody.querySelectorAll("tr").forEach((tr) => {
            tr.querySelectorAll("input, select").forEach((inp) => {
              if (!showCriticite) {
                inp.required = false;
                return;
              }
              if (inp.getAttribute("data-required") === "1") {
                inp.required = true;
              }
            });
          });
        }

        if (achetableTbody) {
          achetableTbody.querySelectorAll("tr").forEach((tr) => {
            tr.querySelectorAll("input, select").forEach((inp) => {
              if (!showAchetable) {
                inp.required = false;
                return;
              }
              if (inp.getAttribute("data-required") === "1") {
                inp.required = true;
              }
            });
          });
        }

        if (equivalenceTbody) {
          equivalenceTbody.querySelectorAll("tr").forEach((tr) => {
            tr.querySelectorAll("input, select").forEach((inp) => {
              if (!showEquivalence) {
                inp.required = false;
                return;
              }
              if (inp.getAttribute("data-required") === "1") {
                inp.required = true;
              }
            });
          });
        }

        if (rebutTbody) {
          rebutTbody.querySelectorAll("tr").forEach((tr) => {
            tr.querySelectorAll("input, select").forEach((inp) => {
              if (!showRebut) {
                inp.required = false;
                return;
              }
              if (inp.getAttribute("data-required") === "1") {
                inp.required = true;
              }
            });
          });
        }

        if (creationTbody) {
          creationTbody.querySelectorAll("tr").forEach((tr) => {
            tr.querySelectorAll("input, select").forEach((inp) => {
              if (!showCreation) {
                inp.required = false;
                return;
              }
              if (inp.getAttribute("data-required") === "1") {
                inp.required = true;
              }
            });
          });
        }
      }

      select.addEventListener("change", updateVisibility);
      firstname.addEventListener("input", updateVisibility);
      lastname.addEventListener("input", updateVisibility);
      firstname.addEventListener("change", updateVisibility);
      lastname.addEventListener("change", updateVisibility);
      firstname.addEventListener("blur", updateVisibility);
      lastname.addEventListener("blur", updateVisibility);
      window.setTimeout(updateVisibility, 0);

      if (criticiteAddRowBtn && criticiteTbody) {
        criticiteAddRowBtn.addEventListener("click", () => {
          const row = createCriticiteRow();
          criticiteTbody.appendChild(row.tr);
        });
      }

      if (achetableAddRowBtn && achetableTbody) {
        achetableAddRowBtn.addEventListener("click", () => {
          const row = createAchetableRow();
          achetableTbody.appendChild(row.tr);
        });
      }

      if (equivalenceAddRowBtn && equivalenceTbody) {
        equivalenceAddRowBtn.addEventListener("click", () => {
          const row = createEquivalenceRow();
          equivalenceTbody.appendChild(row.tr);
        });
      }

      if (rebutAddRowBtn && rebutTbody) {
        rebutAddRowBtn.addEventListener("click", () => {
          const row = createRebutRow();
          rebutTbody.appendChild(row.tr);
        });
      }

      if (creationModeForm) {
        creationModeForm.addEventListener("change", () => setCreationMode("form"));
      }
      if (creationModeExcel) {
        creationModeExcel.addEventListener("change", () => setCreationMode("excel"));
      }

      if (creationTemplateDownloadBtn) {
        creationTemplateDownloadBtn.addEventListener("click", () => {
          if (typeof API !== "function") return;
          window.open(API("/downloads/demandes/creation_articles_template_xlsx"), "_blank", "noopener,noreferrer");
        });
      }

      if (creationImportFileInp) {
        creationImportFileInp.addEventListener("change", async () => {
          const f = creationImportFileInp.files && creationImportFileInp.files[0] ? creationImportFileInp.files[0] : null;
          await importCreationRowsFromXlsx(f);
          creationImportFileInp.value = "";
        });
      }

      // Charger les valeurs possibles de feuille_du_catalogue depuis items.parquet
      loadFeuillesDuCatalogueOptions();
      loadFabricantsOptions();

      const creationFormMatDang = document.getElementById("creation-form-mat-dang");
      if (creationFormMatDang) {
        creationFormMatDang.addEventListener("change", updateCreationFormMdVisibility);
      }
      updateCreationFormMdVisibility();

      const creationFormCatMd = document.getElementById("creation-form-cat-md");
      if (creationFormCatMd) {
        creationFormCatMd.addEventListener("change", updateCreationFormMdVisibility);
      }

      const creationFormConsoFlag = document.getElementById("creation-form-cat-conso-flag");
      if (creationFormConsoFlag) {
        creationFormConsoFlag.addEventListener("change", updateCreationFormConsoVisibility);
      }
      updateCreationFormConsoVisibility();

      const creationFormTypeArticle = document.getElementById("creation-form-type");
      if (creationFormTypeArticle) {
        creationFormTypeArticle.addEventListener("change", updateCreationFormMnemoVisibility);
      }
      updateCreationFormMnemoVisibility();

      const creationFormLibCourt = document.getElementById("creation-form-libelle-court");
      const creationFormLibLong = document.getElementById("creation-form-libelle-long");
      const creationFormLibCourtCounter = document.getElementById("creation-form-libelle-court-counter");
      const creationFormLibLongCounter = document.getElementById("creation-form-libelle-long-counter");
      const LIB_COURT_LIMIT = 120;
      const LIB_LONG_LIMIT = 240;

      function updateCreationLibCounter(inp, counterEl, limit) {
        if (!inp || !counterEl) return;
        const n = String(inp.value || "").length;
        const remaining = limit - n;
        if (remaining >= 0) {
          counterEl.textContent = `${remaining} caractère(s) restant(s) (sur ${limit} max)`;
          counterEl.style.color = "";
          counterEl.style.fontWeight = "";
        } else {
          counterEl.textContent = `${Math.abs(remaining)} caractère(s) en trop (au-delà de ${limit} max)`;
          counterEl.style.color = "#dc2626";
          counterEl.style.fontWeight = "600";
        }
      }

      function updateCreationLibCounters() {
        updateCreationLibCounter(creationFormLibCourt, creationFormLibCourtCounter, LIB_COURT_LIMIT);
        updateCreationLibCounter(creationFormLibLong, creationFormLibLongCounter, LIB_LONG_LIMIT);
      }

      if (creationFormLibCourt) {
        const onBlur = () => {
          creationFormLibCourt.value = toUpperNoAccents(creationFormLibCourt.value || "").slice(0, LIB_COURT_LIMIT);
          updateCreationLibCounters();
        };
        creationFormLibCourt.addEventListener("input", updateCreationLibCounters);
        creationFormLibCourt.addEventListener("change", updateCreationLibCounters);
        creationFormLibCourt.addEventListener("blur", onBlur);
      }
      if (creationFormLibLong) {
        const onBlur = () => {
          creationFormLibLong.value = toUpperNoAccents(creationFormLibLong.value || "").slice(0, LIB_LONG_LIMIT);
          updateCreationLibCounters();
        };
        creationFormLibLong.addEventListener("input", updateCreationLibCounters);
        creationFormLibLong.addEventListener("change", updateCreationLibCounters);
        creationFormLibLong.addEventListener("blur", onBlur);
      }
      updateCreationLibCounters();

      const creationFormRefFab = document.getElementById("creation-form-ref-fab");
      const creationFormRefFabCounter = document.getElementById("creation-form-ref-fab-counter");
      const creationFormRefFabCheck = document.getElementById("creation-form-ref-fab-check");
      const REF_FAB_SOFT_LIMIT = 31;
      function updateCreationRefFabCounter() {
        if (!creationFormRefFabCounter || !creationFormRefFab) return;
        const n = String(creationFormRefFab.value || "").length;
        const remaining = REF_FAB_SOFT_LIMIT - n;
        if (remaining >= 0) {
          creationFormRefFabCounter.textContent = `${remaining} caractère(s) restant(s) (sur ${REF_FAB_SOFT_LIMIT} conseillés)`;
          creationFormRefFabCounter.style.color = "";
          creationFormRefFabCounter.style.fontWeight = "";
        } else {
          creationFormRefFabCounter.textContent = `${Math.abs(remaining)} caractère(s) en trop (au-delà des ${REF_FAB_SOFT_LIMIT} conseillés)`;
          creationFormRefFabCounter.style.color = "#dc2626";
          creationFormRefFabCounter.style.fontWeight = "600";
        }
      }

      let _refFabCheckSeq = 0;
      async function checkRefFabAlreadyExists() {
        if (!creationFormRefFab || !creationFormRefFabCheck) return;
        const refFab = norm(creationFormRefFab.value || "");
        if (!refFab) {
          creationFormRefFabCheck.textContent = "";
          creationFormRefFabCheck.style.color = "";
          creationFormRefFabCheck.style.fontWeight = "";
          return;
        }

        const fabricant = norm(document.getElementById("creation-form-fabricant")?.value || "");
        const seq = ++_refFabCheckSeq;
        creationFormRefFabCheck.textContent = "Vérification PIM en cours...";
        creationFormRefFabCheck.style.color = "";
        creationFormRefFabCheck.style.fontWeight = "";

        if (typeof API !== "function") {
          creationFormRefFabCheck.textContent = "";
          return;
        }

        try {
          const qs = new URLSearchParams({ reference: refFab });
          if (fabricant) qs.set("fabricant", fabricant);
          const resp = await fetch(API(`/items/pim/check_reference_fabricant?${qs.toString()}`), {
            method: "GET",
            credentials: "include",
          });
          const data = await resp.json().catch(() => null);
          if (seq !== _refFabCheckSeq) return;
          if (!resp.ok || !data) {
            creationFormRefFabCheck.textContent = "";
            return;
          }

          if (data.exists) {
            const url = `items.html?ref_fab=${encodeURIComponent(refFab)}`;
            creationFormRefFabCheck.innerHTML = `Référence déjà présente dans le PIM (article potentiellement déjà créé). <a href="${url}" target="_blank" rel="noopener noreferrer">Lien</a>`;
            creationFormRefFabCheck.style.color = "#dc2626";
            creationFormRefFabCheck.style.fontWeight = "600";
          } else {
            creationFormRefFabCheck.textContent = "Aucune correspondance trouvée dans le PIM.";
            creationFormRefFabCheck.style.color = "#16a34a";
            creationFormRefFabCheck.style.fontWeight = "600";
          }
        } catch (e) {
          if (seq !== _refFabCheckSeq) return;
          creationFormRefFabCheck.textContent = "";
        }
      }
      if (creationFormRefFab) {
        creationFormRefFab.addEventListener("input", updateCreationRefFabCounter);
        creationFormRefFab.addEventListener("change", updateCreationRefFabCounter);
        creationFormRefFab.addEventListener("blur", () => {
          creationFormRefFab.value = toUpperNoAccents(creationFormRefFab.value || "");
          updateCreationRefFabCounter();
          checkRefFabAlreadyExists();
        });
      }
      updateCreationRefFabCounter();

      const creationFormFabricant = document.getElementById("creation-form-fabricant");
      if (creationFormFabricant) {
        const openFabricantDatalist = () => {
          const dl = document.getElementById("creation-form-fabricant-list");
          const hasOptions = !!(dl && dl.options && dl.options.length);
          if (!hasOptions) return;

          // Astuce : certains navigateurs n'affichent la datalist qu'après un "input" ou une touche.
          creationFormFabricant.dispatchEvent(new Event("input", { bubbles: true }));
          window.requestAnimationFrame(() => {
            try {
              creationFormFabricant.dispatchEvent(
                new KeyboardEvent("keydown", { key: "ArrowDown", code: "ArrowDown", bubbles: true })
              );
            } catch (e) {
              // ignore
            }
          });
        };

        creationFormFabricant.addEventListener("input", updateCreationFabricantIsNew);
        creationFormFabricant.addEventListener("change", updateCreationFabricantIsNew);
        creationFormFabricant.addEventListener("blur", updateCreationFabricantIsNew);
        creationFormFabricant.addEventListener("focus", openFabricantDatalist);
        creationFormFabricant.addEventListener("click", openFabricantDatalist);
      }

      if (creationAddRowBtn && creationTbody) {
        creationAddRowBtn.addEventListener("click", () => {
          const row = createCreationRow();
          creationTbody.appendChild(row.tr);
        });
      }

      function getCreationRowsFromForm() {
        const article = norm(document.getElementById("creation-form-article")?.value || "");
        const feuille = norm(document.getElementById("creation-form-feuille")?.value || "");
        const libCourt = norm(document.getElementById("creation-form-libelle-court")?.value || "");
        const libLong = norm(document.getElementById("creation-form-libelle-long")?.value || "");
        const typeArticle = norm(document.getElementById("creation-form-type")?.value || "");
        const cycleProd = norm(document.getElementById("creation-form-cycle-prod")?.value || "");
        const cycleAchat = norm(document.getElementById("creation-form-cycle-achat")?.value || "");
        const statut = norm(document.getElementById("creation-form-statut")?.value || "");
        const crit = norm(document.getElementById("creation-form-criticite")?.value || "");
        const mnemo = norm(document.getElementById("creation-form-mnemo")?.value || "");
        const fabricant = norm(document.getElementById("creation-form-fabricant")?.value || "");
        const refFab = norm(document.getElementById("creation-form-ref-fab")?.value || "");

        const commTech = norm(document.getElementById("creation-form-comm-tech")?.value || "");
        const poids = norm(document.getElementById("creation-form-poids")?.value || "");
        const longM = norm(document.getElementById("creation-form-long")?.value || "");
        const largM = norm(document.getElementById("creation-form-larg")?.value || "");
        const hautM = norm(document.getElementById("creation-form-haut")?.value || "");
        const datacenter = norm(document.getElementById("creation-form-datacenter")?.value || "");
        const horsNorme = norm(document.getElementById("creation-form-hors-norme")?.value || "");
        const peremption = norm(document.getElementById("creation-form-peremption")?.value || "");
        const matDang = norm(document.getElementById("creation-form-mat-dang")?.value || "");
        const catMd = norm(document.getElementById("creation-form-cat-md")?.value || "");
        const codeOnu = norm(document.getElementById("creation-form-code-onu")?.value || "");
        const catConsoFlag = norm(document.getElementById("creation-form-cat-conso-flag")?.value || "");
        const catConso = norm(document.getElementById("creation-form-cat-conso")?.value || "");
        const sousCatConso = norm(document.getElementById("creation-form-sous-cat-conso")?.value || "");
        const retourProd = norm(document.getElementById("creation-form-retour-prod")?.value || "");
        const prixPrev = norm(document.getElementById("creation-form-prix-prev")?.value || "");

        const row = {
          article_tdf_clt: article,
          feuille_du_catalogue: feuille,
          libelle_court: toUpperNoAccents(libCourt).slice(0, 120),
          libelle_long: toUpperNoAccents(libLong).slice(0, 240),
          type_article: typeArticle,
          cycle_vie_production: cycleProd,
          statut_article: statut,
          cycle_vie_achat: cycleAchat,
          commentaire_technique: commTech,
          poids_kg: poids,
          long_m: longM,
          larg_m: largM,
          haut_m: hautM,
          article_datacenter: datacenter,
          article_hors_norme: horsNorme,
          peremption: peremption,
          matiere_dangereuse: matDang,
          categorie_md: toUpperNoAccents(catMd),
          code_onu: toUpperNoAccents(codeOnu),
          catalogue_consommables: catConsoFlag,
          categorie_consommables: toUpperNoAccents(catConso),
          sous_categorie_consommables: toUpperNoAccents(sousCatConso),
          retour_production: retourProd,
          prix_previsionnel: prixPrev,
          criticite: crit,
          mnemonique: toUpperNoAccents(mnemo).slice(0, 20),
          fabricant: toUpperNoAccents(fabricant),
          reference_fabricant: toUpperNoAccents(refFab),
        };

        return [row];
      }

      function updateCreationFormMdVisibility() {
        const sel = document.getElementById("creation-form-mat-dang");
        const details = document.getElementById("creation-form-md-details");
        const cat = document.getElementById("creation-form-cat-md");
        const onu = document.getElementById("creation-form-code-onu");
        if (!sel || !details || !cat || !onu) return;

        const onuByCat = {
          "Liquide inflammable (peintures, solvants…)": "1263",
          "Aérosol inflammable": "1950",
          "Piles/Batteries Plomb": "2794",
          "Piles/Batteries Plomb étanche": "2800",
          "Pile/Batterie Métal seule": "3090",
          "Pile/Batterie Métal avec/dans équipement": "3091",
          "Pile/Batterie Ionique seule": "3480",
          "Pile/Batterie Ionique avec/dans équipement": "3481",
          "Pile/Batterie Nickel": "3496",
          "Matière dangereuse du point de vue de l'environnement (solide)": "3077",
        };

        const show = isYes(sel.value);
        details.style.display = show ? "flex" : "none";
        cat.required = show;
        onu.required = show;
        const catVal = norm(cat.value);
        const isOther = show && catVal === "Autres (à préciser)";

        const onuMapped = onuByCat[catVal];
        if (show && onuMapped) {
          onu.value = onuMapped;
          onu.readOnly = true;
        } else {
          onu.readOnly = false;
          if (!isOther) {
            // si la catégorie est vide ou non mappée (hors "Autres"), on ne force rien
          }
        }

        if (!show) {
          cat.value = "";
          onu.value = "";
        }
      }

      function updateCreationFormConsoVisibility() {
        const sel = document.getElementById("creation-form-cat-conso-flag");
        const details = document.getElementById("creation-form-conso-details");
        const cat = document.getElementById("creation-form-cat-conso");
        const sous = document.getElementById("creation-form-sous-cat-conso");
        if (!sel || !details || !cat || !sous) return;

        const show = isYes(sel.value);
        details.style.display = show ? "flex" : "none";
        cat.required = show;
        sous.required = show;
        if (!show) {
          cat.value = "";
          sous.value = "";
        }
      }

      function updateCreationFormMnemoVisibility() {
        const typeSel = document.getElementById("creation-form-type");
        const wrap = document.getElementById("creation-form-mnemo-wrap");
        const inp = document.getElementById("creation-form-mnemo");
        if (!typeSel || !wrap || !inp) return;

        const typeVal = norm(typeSel.value);
        const show = !!typeVal && typeVal !== "COMPOS";
        wrap.style.display = show ? "" : "none";
        inp.required = show;
        if (!show) {
          inp.value = "";
        }
      }

      function getCreationRowsFromTable() {
        const rows = [];
        if (!creationTbody) return rows;
        creationTbody.querySelectorAll("tr").forEach((tr) => {
          const v = (n, sel) => norm(tr.querySelector(`td:nth-child(${n}) ${sel}`)?.value || "");
          const fabricant = v(1, "input");
          const refFab = v(2, "input");
          const prixPrev = v(3, "input");
          const article = v(4, "select");
          const feuille = v(5, "select");
          const libCourt = v(6, "input");
          const libLong = v(7, "input");
          const typeArticle = v(8, "select");
          const mnemo = v(9, "input");
          const cycleProd = v(10, "select");
          const cycleAchat = v(11, "select");
          const statut = v(12, "select");
          const crit = v(13, "select");
          const commTech = v(14, "input");
          const poids = v(15, "input");
          const longM = v(16, "input");
          const largM = v(17, "input");
          const hautM = v(18, "input");
          const datacenter = v(19, "select");
          const horsNorme = v(20, "select");
          const peremption = v(21, "select");
          const retourProd = v(22, "select");
          const matDang = v(23, "select");
          const catMd = v(24, "select");
          const codeOnu = v(25, "input");
          const catConsoFlag = v(26, "select");
          const catConso = v(27, "select");
          const sousCatConso = v(28, "select");

          if (!article && !feuille && !libCourt && !libLong && !typeArticle) return;

          rows.push({
            article_tdf_clt: norm(article),
            feuille_du_catalogue: norm(feuille),
            libelle_court: toUpperNoAccents(libCourt).slice(0, 120),
            libelle_long: toUpperNoAccents(libLong).slice(0, 240),
            type_article: norm(typeArticle),
            cycle_vie_production: norm(cycleProd),
            statut_article: norm(statut),
            cycle_vie_achat: norm(cycleAchat),
            commentaire_technique: norm(commTech),
            poids_kg: norm(poids),
            long_m: norm(longM),
            larg_m: norm(largM),
            haut_m: norm(hautM),
            article_datacenter: norm(datacenter),
            article_hors_norme: norm(horsNorme),
            peremption: norm(peremption),
            matiere_dangereuse: norm(matDang),
            categorie_md: toUpperNoAccents(catMd),
            code_onu: toUpperNoAccents(codeOnu),
            catalogue_consommables: norm(catConsoFlag),
            categorie_consommables: toUpperNoAccents(catConso),
            sous_categorie_consommables: toUpperNoAccents(sousCatConso),
            retour_production: norm(retourProd),
            prix_previsionnel: norm(prixPrev),
            criticite: norm(crit),
            mnemonique: toUpperNoAccents(mnemo).slice(0, 20),
            fabricant: toUpperNoAccents(fabricant),
            reference_fabricant: toUpperNoAccents(refFab),
          });
        });
        return rows;
      }

      function validateCreationRows(rows) {
        const missingRow = (rows || []).find((r) => {
          if (!r) return true;
          return !r.article_tdf_clt
            || !r.feuille_du_catalogue
            || !r.libelle_court
            || !r.libelle_long
            || !r.type_article
            || !r.cycle_vie_production
            || !r.cycle_vie_achat
            || !r.statut_article
            || !r.criticite
            || !r.fabricant
            || !r.reference_fabricant
            || !r.prix_previsionnel
            || !r.article_datacenter
            || !r.peremption
            || !r.matiere_dangereuse;
        });

        if (missingRow) {
          const missing = [];
          if (!missingRow.article_tdf_clt) missing.push("Article TDF/CLT");
          if (!missingRow.feuille_du_catalogue) missing.push("Feuille du catalogue");
          if (!missingRow.fabricant) missing.push("Fabricant");
          if (!missingRow.reference_fabricant) missing.push("Référence fabricant");
          if (!missingRow.prix_previsionnel) missing.push("Prix prévisionnel");
          if (!missingRow.libelle_court) missing.push("Libellé court");
          if (!missingRow.libelle_long) missing.push("Libellé long");
          if (!missingRow.type_article) missing.push("Type article");
          if (!missingRow.cycle_vie_production) missing.push("Cycle de vie production");
          if (!missingRow.cycle_vie_achat) missing.push("Cycle de vie achat");
          if (!missingRow.statut_article) missing.push("Statut d'article");
          if (!missingRow.criticite) missing.push("Criticité");
          if (!missingRow.article_datacenter) missing.push("Article datacenter");
          if (!missingRow.peremption) missing.push("Péremption");
          if (!missingRow.matiere_dangereuse) missing.push("Matière dangereuse");
          return "Champs obligatoires manquants : " + missing.join(", ") + ".";
        }

        const mnemoMissing = rows.some((r) => norm(r.type_article) && norm(r.type_article) !== "COMPOS" && !r.mnemonique);
        if (mnemoMissing) return "Si 'Type article' ≠ COMPOS, alors 'Mnémonique' est obligatoire.";

        const libCourtTooLong = rows.some((r) => String(r.libelle_court || "").length > 120);
        const libLongTooLong = rows.some((r) => String(r.libelle_long || "").length > 240);
        const mnemoTooLong = rows.some((r) => String(r.mnemonique || "").length > 20);
        if (libCourtTooLong || libLongTooLong || mnemoTooLong) {
          return "Un ou plusieurs champs dépassent la longueur maximale (libellés / mnémonique).";
        }

        const mdMissing = rows.some((r) => isYes(r.matiere_dangereuse) && (!r.categorie_md || !r.code_onu));
        if (mdMissing) return "Si 'Matière dangereuse' = OUI, alors Catégories MD et Codes ONU sont obligatoires.";

        const consoMissing = rows.some((r) => isYes(r.catalogue_consommables) && (!r.categorie_consommables || !r.sous_categorie_consommables));
        if (consoMissing) return "Si 'Catalogue des consommables' = OUI, alors Catégorie et Sous-catégorie consommables sont obligatoires.";

        return "";
      }

      if (creationValidateBtn) {
        creationValidateBtn.addEventListener("click", async () => {
          const showCreation = select.value === "creation_articles" && hasRequester();
          if (!showCreation) {
            if (creationFeedback) {
              creationFeedback.textContent = "Veuillez sélectionner 'Création d'article(s)' et renseigner prénom/nom.";
            }
            return;
          }

          const useExcel = creationModeExcel && creationModeExcel.checked;
          const rows = useExcel ? getCreationRowsFromTable() : getCreationRowsFromForm();

          if (rows.length === 0) {
            if (creationFeedback) creationFeedback.textContent = "Veuillez renseigner au moins une ligne.";
            return;
          }

          const error = validateCreationRows(rows);
          if (error) {
            if (creationFeedback) creationFeedback.textContent = error;
            return;
          }

          const now = new Date();
          const dateStr = toIsoLocal(now);
          const requesterFirstname = norm(firstname.value);
          const requesterLastname = norm(lastname.value);
          const requester = `${requesterFirstname} ${requesterLastname}`.trim();
          const subject = `[DDE MODIF ARTICLE] - Création article(s) - ${requester} - ${dateStr}`;
          const to = "referentiel_logistique@tdf.fr";

          let savedInfo = null;
          if (typeof API === "function") {
            try {
              if (creationFeedback) {
                creationFeedback.textContent = "Sauvegarde Excel en cours...";
              }
              const resp = await fetch(API("/downloads/demandes/creation_articles_xlsx"), {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  date_demande: dateStr,
                  demandeur: requester,
                  type_demande: "Création d'article(s)",
                  rows,
                }),
              });
              const data = await resp.json().catch(() => null);
              if (resp.ok && data && data.ok) {
                savedInfo = data;
              } else {
                savedInfo = null;
              }
            } catch (e) {
              savedInfo = null;
            }
          }

          const columns = [
            "fabricant",
            "reference_fabricant",
            "prix_previsionnel",
            "article_tdf_clt",
            "feuille_du_catalogue",
            "libelle_court",
            "libelle_long",
            "type_article",
            "mnemonique",
            "cycle_vie_production",
            "cycle_vie_achat",
            "statut_article",
            "criticite",
            "commentaire_technique",
            "poids_kg",
            "long_m",
            "larg_m",
            "haut_m",
            "article_datacenter",
            "article_hors_norme",
            "peremption",
            "retour_production",
            "matiere_dangereuse",
            "categorie_md",
            "code_onu",
            "catalogue_consommables",
            "categorie_consommables",
            "sous_categorie_consommables",
          ];

          const header = [
            "Demande : Création d'article(s)",
            `Demandeur : ${requester}`,
            `Date : ${dateStr}`,
            savedInfo && savedInfo.dir ? `Répertoire de sauvegarde : ${savedInfo.dir}` : "Répertoire de sauvegarde : (non disponible)",
            savedInfo && savedInfo.path ? `Fichier Excel sauvegardé : ${savedInfo.path}` : "Fichier Excel non sauvegardé (API/accès partage).",
            "",
            columns.join("\t"),
          ];

          const safeText = (v) => String(v || "").replace(/\s+/g, " ").trim();
          const lines = rows.map((r) => columns.map((c) => safeText(r[c])).join("\t"));
          const body = header.concat(lines).join("\n");
          const mailtoUrl = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

          if (creationFeedback) {
            creationFeedback.textContent = savedInfo && savedInfo.path
              ? "Fichier Excel sauvegardé. Ouverture du mail..."
              : "Impossible de sauvegarder le fichier Excel. Ouverture du mail quand même.";
          }
          window.location.href = mailtoUrl;
        });
      }

      if (rebutValidateBtn) {
        rebutValidateBtn.addEventListener("click", async () => {
          const showRebut = select.value === "passage_rebut" && hasRequester();
          if (!showRebut) {
            if (rebutFeedback) {
              rebutFeedback.textContent = "Veuillez sélectionner 'Demande de passage en REBUT' et renseigner prénom/nom.";
            }
            return;
          }

          const rows = [];
          if (rebutTbody) {
            rebutTbody.querySelectorAll("tr").forEach((tr) => {
              const code = norm(tr.querySelector("td:nth-child(1) input")?.value || "");
              const lib = norm(tr.querySelector("td:nth-child(2) input")?.value || "");
              const feuille = norm(tr.querySelector("td:nth-child(3) input")?.value || "");
              const typeArticle = norm(tr.querySelector("td:nth-child(4) input")?.value || "");
              const statut = norm(tr.querySelector("td:nth-child(5) input")?.value || "");
              const crit = norm(tr.querySelector("td:nth-child(6) input")?.value || "");
              const cycleProd = norm(tr.querySelector("td:nth-child(7) input")?.value || "");
              const cycleAchat = norm(tr.querySelector("td:nth-child(8) input")?.value || "");
              const lieuRep = norm(tr.querySelector("td:nth-child(9) input")?.value || "");
              const rma = norm(tr.querySelector("td:nth-child(10) input")?.value || "");
              const retourProd = norm(tr.querySelector("td:nth-child(11) input")?.value || "");

              if (!code && !lib && !feuille && !typeArticle) return;
              rows.push({ code, lib, feuille, typeArticle, statut, crit, cycleProd, cycleAchat, lieuRep, rma, retourProd });
            });
          }

          const missing = rows.some((r) => !r.code);
          if (rows.length === 0 || missing) {
            if (rebutFeedback) {
              rebutFeedback.textContent = "Veuillez renseigner au moins une ligne (code_article).";
            }
            return;
          }

          let excelInfo = null;
          if (typeof API === "function") {
            try {
              if (rebutFeedback) {
                rebutFeedback.textContent = "Sauvegarde Excel en cours...";
              }
              const payload = {
                date_demande: toIsoLocal(new Date()),
                demandeur: `${norm(firstname.value)} ${norm(lastname.value)}`.trim(),
                type_demande: "Demande de passage en REBUT",
                rows: rows.map((r) => ({
                  code_article: r.code,
                  libelle_article: r.lib,
                  feuille_du_catalogue: r.feuille,
                  type_article: r.typeArticle,
                  statut_abrege_article: r.statut,
                  criticite: r.crit,
                  cycle_de_vie_de_production_pim: r.cycleProd,
                  cycle_de_vie_achat: r.cycleAchat,
                  lieu_de_reparation_pim: r.lieuRep,
                  rma: r.rma,
                  retour_production: r.retourProd,
                })),
              };

              const resp = await fetch(API(`/downloads/demandes/passage_rebut_xlsx`), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(payload),
              });
              if (resp.ok) {
                excelInfo = await resp.json().catch(() => null);
              } else {
                excelInfo = null;
              }
            } catch (e) {
              excelInfo = null;
            }
          }

          const now = new Date();
          const dateStr = toIsoLocal(now);
          const requesterFirstname = norm(firstname.value);
          const requesterLastname = norm(lastname.value);
          const requester = `${requesterFirstname} ${requesterLastname}`.trim();
          const subject = `[DDE MODIF ARTICLE] - Passage en REBUT - ${requester} - ${dateStr}`;
          const to = "referentiel_logistique@tdf.fr";

          const safeText = (v) => String(v || "").replace(/\s+/g, " ").trim();
          const cut = (s, n) => {
            const t = safeText(s);
            if (t.length <= n) return t;
            return t.slice(0, Math.max(0, n - 1)) + "…";
          };

          const columns = [
            "code_article",
            "libelle_article",
            "feuille_du_catalogue",
            "type_article",
            "statut_abrege_article",
            "criticite",
            "cycle_de_vie_de_production_pim",
            "cycle_de_vie_achat",
            "lieu_de_reparation_pim",
            "rma",
            "retour_production",
          ];

          const header = [
            "Demande : Passage en REBUT",
            `Demandeur : ${requester}`,
            `Date : ${dateStr}`,
            excelInfo && excelInfo.dir ? `Répertoire de sauvegarde : ${excelInfo.dir}` : "Répertoire de sauvegarde : (non disponible)",
            excelInfo && excelInfo.path ? `Fichier Excel sauvegardé : ${excelInfo.path}` : "Fichier Excel non sauvegardé (API/accès partage).",
            "",
            columns.join("\t"),
          ];

          const lines = rows.map((r) => {
            const vals = [
              cut(r.code, 40),
              cut(r.lib, 120),
              cut(r.feuille, 60),
              cut(r.typeArticle, 60),
              cut(r.statut, 60),
              cut(r.crit, 40),
              cut(r.cycleProd, 80),
              cut(r.cycleAchat, 80),
              cut(r.lieuRep, 80),
              cut(r.rma, 40),
              cut(r.retourProd, 60),
            ];
            return vals.join("\t");
          });

          const body = header.concat(lines).join("\n");
          const mailtoUrl = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

          if (rebutFeedback) {
            rebutFeedback.textContent = "Ouverture du mail...";
          }
          window.location.href = mailtoUrl;
        });
      }

      if (criticiteValidateBtn) {
        criticiteValidateBtn.addEventListener("click", async () => {
          const showCriticite = select.value === "modification_criticite" && hasRequester();
          if (!showCriticite) {
            if (criticiteFeedback) {
              criticiteFeedback.textContent = "Veuillez sélectionner 'Modification d'une criticité' et renseigner prénom/nom.";
            }
            return;
          }

          const rows = [];
          if (criticiteTbody) {
            criticiteTbody.querySelectorAll("tr").forEach((tr) => {
              const code = norm(tr.querySelector("td:nth-child(1) input")?.value || "");
              const feuille = norm(tr.querySelector("td:nth-child(2) input")?.value || "");
              const typeArticle = norm(tr.querySelector("td:nth-child(3) input")?.value || "");
              const lib = norm(tr.querySelector("td:nth-child(4) input")?.value || "");
              const crit = norm(tr.querySelector("td:nth-child(5) input")?.value || "");
              const newCrit = norm(tr.querySelector("td:nth-child(6) select")?.value || "");
              const cause = norm(tr.querySelector("td:nth-child(7) input")?.value || "");

              if (!code && !newCrit && !cause) return;
              rows.push({ code, feuille, typeArticle, lib, crit, newCrit, cause });
            });
          }

          const missing = rows.some((r) => !r.code || !r.newCrit || !r.cause);
          if (rows.length === 0 || missing) {
            if (criticiteFeedback) {
              criticiteFeedback.textContent = "Veuillez renseigner au moins une ligne complète (code_article, nouvelle criticité, cause).";
            }
            return;
          }

          const now = new Date();
          const dateStr = toIsoLocal(now);
          const requesterFirstname = norm(firstname.value);
          const requesterLastname = norm(lastname.value);
          const requester = `${requesterFirstname} ${requesterLastname}`.trim();
          const typeDemandeLabel = "Modification d'une criticité";

          const subject = `[DDE MODIF ARTICLE] - Changement de criticité - ${requester} - ${dateStr}`;

          const safeText = (v) => String(v || "").replace(/\s+/g, " ").trim();
          const to = "referentiel_logistique@tdf.fr";

          const widths = {
            code: 12,
            feuille: 20,
            typeArticle: 20,
            lib: 70,
            crit: 10,
            newCrit: 12,
            cause: 60,
          };

          const cut = (s, n) => {
            const t = safeText(s);
            if (t.length <= n) return t;
            return t.slice(0, Math.max(0, n - 1)) + "…";
          };
          const pad = (s, n) => {
            const t = String(s || "");
            if (t.length >= n) return t;
            return t + " ".repeat(n - t.length);
          };

          const lineSep = () => {
            const parts = [
              "-".repeat(widths.code),
              "-".repeat(widths.feuille),
              "-".repeat(widths.typeArticle),
              "-".repeat(widths.lib),
              "-".repeat(widths.crit),
              "-".repeat(widths.newCrit),
              "-".repeat(widths.cause),
            ];
            return `+${parts.join("+")}+`;
          };

          const headerRow = () => {
            const parts = [
              pad("code_article", widths.code),
              pad("feuille_de_catalogue", widths.feuille),
              pad("type_article", widths.typeArticle),
              pad("libelle_article", widths.lib),
              pad("criticite", widths.crit),
              pad("nouvelle", widths.newCrit),
              pad("causes", widths.cause),
            ];
            return `|${parts.join("|")}|`;
          };

          const dataRows = rows.map((r) => {
            const parts = [
              pad(cut(r.code, widths.code), widths.code),
              pad(cut(r.feuille, widths.feuille), widths.feuille),
              pad(cut(r.typeArticle, widths.typeArticle), widths.typeArticle),
              pad(cut(r.lib, widths.lib), widths.lib),
              pad(cut(r.crit, widths.crit), widths.crit),
              pad(cut(r.newCrit, widths.newCrit), widths.newCrit),
              pad(cut(r.cause, widths.cause), widths.cause),
            ];
            return `|${parts.join("|")}|`;
          });

          const tsv = [
            "code_article\tfeuille_du_catalogue\ttype_article\tlibelle_article\tcriticite_article\tnouvelle_criticite_article\tcauses",
            ...rows.map((r) => [safeText(r.code), safeText(r.feuille), safeText(r.typeArticle), safeText(r.lib), safeText(r.crit), safeText(r.newCrit), safeText(r.cause)].join("\t")),
          ].join("\n");

          const apiRows = rows.map((r) => ({
            code_article: safeText(r.code),
            feuille_du_catalogue: safeText(r.feuille),
            type_article: safeText(r.typeArticle),
            libelle_article: safeText(r.lib),
            criticite_article: safeText(r.crit),
            nouvelle_criticite_article: safeText(r.newCrit),
            causes: safeText(r.cause),
          }));

          let savedInfo = null;
          if (typeof API === "function") {
            try {
              if (criticiteFeedback) {
                criticiteFeedback.textContent = "Sauvegarde du fichier Excel sur le partage...";
              }
              const resp = await fetch(API("/downloads/demandes/modif_criticite_xlsx"), {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  date_demande: dateStr,
                  demandeur: requester,
                  type_demande: typeDemandeLabel,
                  rows: apiRows,
                }),
              });
              const data = await resp.json().catch(() => null);
              if (resp.ok && data && data.ok) {
                savedInfo = data;
              } else {
                savedInfo = null;
              }
            } catch (e) {
              savedInfo = null;
            }
          }

          const pieceJointeLine = savedInfo && savedInfo.filename
            ? `Fichier Excel sauvegardé : ${savedInfo.filename}`
            : "Fichier Excel non sauvegardé (vérifier accès au partage \\\\apps\\... ).";

          const bodyText = [
            `Type de demande : ${typeDemandeLabel}`,
            `Prénom : ${requesterFirstname}`,
            `Nom : ${requesterLastname}`,
            `Date de la demande : ${dateStr}`,
            pieceJointeLine,
            "",
            tsv,
            "",
          ].join("\n");

          const mailtoWithBody = () => {
            const mailto = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyText)}`;
            window.location.href = mailto;
          };

          // Vérifier une limite conservative d'URL mailto (varie selon Windows/Outlook/navigateur).
          // Si l'URL est trop longue, on n'essaie PAS de créer un second email.
          const MAILTO_URL_LIMIT = 1800;
          const fullUrl = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyText)}`;
          if (fullUrl.length > MAILTO_URL_LIMIT) {
            if (criticiteFeedback) {
              criticiteFeedback.textContent = "Le contenu est trop long pour être envoyé via mailto. Réduisez le nombre de lignes ou la longueur des causes.";
            }
            return;
          }

          if (criticiteFeedback) {
            criticiteFeedback.textContent = savedInfo && savedInfo.filename
              ? `Fichier Excel sauvegardé sur le partage : ${savedInfo.filename}. Ouverture du mail...`
              : "Impossible de sauvegarder le fichier Excel sur le partage. Ouverture du mail quand même.";
          }

          window.location.href = fullUrl;
        });
      }

      if (achetableValidateBtn) {
        achetableValidateBtn.addEventListener("click", async () => {
          const showAchetable = select.value === "modification_achetable" && hasRequester();
          if (!showAchetable) {
            if (achetableFeedback) {
              achetableFeedback.textContent = "Veuillez sélectionner 'Modification du statut achetable / non achetable' et renseigner prénom/nom.";
            }
            return;
          }

          const rows = [];
          if (achetableTbody) {
            achetableTbody.querySelectorAll("tr").forEach((tr) => {
              const code = norm(tr.querySelector("td:nth-child(1) input")?.value || "");
              const feuille = norm(tr.querySelector("td:nth-child(2) input")?.value || "");
              const typeArticle = norm(tr.querySelector("td:nth-child(3) input")?.value || "");
              const lib = norm(tr.querySelector("td:nth-child(4) input")?.value || "");
              const statutActuel = norm(tr.querySelector("td:nth-child(5) input")?.value || "");
              const nouveauStatut = norm(tr.querySelector("td:nth-child(6) select")?.value || "");
              const cause = norm(tr.querySelector("td:nth-child(7) input")?.value || "");

              if (!code && !nouveauStatut && !cause) return;
              rows.push({ code, feuille, typeArticle, lib, statutActuel, nouveauStatut, cause });
            });
          }

          const missing = rows.some((r) => !r.code || !r.nouveauStatut || !r.cause);
          if (rows.length === 0 || missing) {
            if (achetableFeedback) {
              achetableFeedback.textContent = "Veuillez renseigner au moins une ligne complète (code_article, nouveau statut, cause).";
            }
            return;
          }

          const now = new Date();
          const dateStr = toIsoLocal(now);
          const requesterFirstname = norm(firstname.value);
          const requesterLastname = norm(lastname.value);
          const requester = `${requesterFirstname} ${requesterLastname}`.trim();
          const typeDemandeLabel = "Modification du statut achetable / non achetable";

          const subject = `[DDE MODIF ARTICLE] - Statut achetable/non achetable - ${requester} - ${dateStr}`;

          const safeText = (v) => String(v || "").replace(/\s+/g, " ").trim();
          const to = "referentiel_logistique@tdf.fr";

          const tsv = [
            "code_article\tfeuille_du_catalogue\ttype_article\tlibelle_article\tstatut_abrege_article\tnouveau_statut_abrege_article\tcauses",
            ...rows.map((r) => [
              safeText(r.code),
              safeText(r.feuille),
              safeText(r.typeArticle),
              safeText(r.lib),
              safeText(r.statutActuel),
              safeText(r.nouveauStatut),
              safeText(r.cause),
            ].join("\t")),
          ].join("\n");

          const apiRows = rows.map((r) => ({
            code_article: safeText(r.code),
            feuille_du_catalogue: safeText(r.feuille),
            type_article: safeText(r.typeArticle),
            libelle_article: safeText(r.lib),
            statut_abrege_article: safeText(r.statutActuel),
            nouveau_statut_abrege_article: safeText(r.nouveauStatut),
            causes: safeText(r.cause),
          }));

          let savedInfo = null;
          if (typeof API === "function") {
            try {
              if (achetableFeedback) {
                achetableFeedback.textContent = "Sauvegarde du fichier Excel sur le partage...";
              }
              const resp = await fetch(API("/downloads/demandes/modif_achetable_xlsx"), {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  date_demande: dateStr,
                  demandeur: requester,
                  type_demande: typeDemandeLabel,
                  rows: apiRows,
                }),
              });
              const data = await resp.json().catch(() => null);
              if (resp.ok && data && data.ok) {
                savedInfo = data;
              } else {
                savedInfo = null;
              }
            } catch (e) {
              savedInfo = null;
            }
          }

          const pieceJointeLine = savedInfo && savedInfo.filename
            ? `Fichier Excel sauvegardé : ${savedInfo.filename}`
            : "Fichier Excel non sauvegardé (vérifier accès au partage \\\\apps\\... ).";

          const bodyText = [
            `Type de demande : ${typeDemandeLabel}`,
            `Prénom : ${requesterFirstname}`,
            `Nom : ${requesterLastname}`,
            `Date de la demande : ${dateStr}`,
            pieceJointeLine,
            "",
            tsv,
            "",
          ].join("\n");

          const MAILTO_URL_LIMIT = 1800;
          const fullUrl = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyText)}`;
          if (fullUrl.length > MAILTO_URL_LIMIT) {
            if (achetableFeedback) {
              achetableFeedback.textContent = "Le contenu est trop long pour être envoyé via mailto. Réduisez le nombre de lignes ou la longueur des champs.";
            }
            return;
          }

          if (achetableFeedback) {
            achetableFeedback.textContent = savedInfo && savedInfo.filename
              ? `Fichier Excel sauvegardé sur le partage : ${savedInfo.filename}. Ouverture du mail...`
              : "Impossible de sauvegarder le fichier Excel sur le partage. Ouverture du mail quand même.";
          }

          window.location.href = fullUrl;
        });
      }

      if (equivalenceValidateBtn) {
        equivalenceValidateBtn.addEventListener("click", async () => {
          const showEquivalence = select.value === "declaration_equivalence" && hasRequester();
          if (!showEquivalence) {
            if (equivalenceFeedback) {
              equivalenceFeedback.textContent = "Veuillez sélectionner 'Déclaration d\"une équivalence' et renseigner prénom/nom.";
            }
            return;
          }

          const rows = [];
          if (equivalenceTbody) {
            equivalenceTbody.querySelectorAll("tr").forEach((tr) => {
              const code_article = norm(tr.querySelector("td:nth-child(1) input")?.value || "");
              const libelle_article = norm(tr.querySelector("td:nth-child(2) input")?.value || "");
              const code_equivalent = norm(tr.querySelector("td:nth-child(3) input")?.value || "");
              const libelle_article_equivalent = norm(tr.querySelector("td:nth-child(4) input")?.value || "");
              const type_equivalence = norm(tr.querySelector("td:nth-child(5) select")?.value || "");
              const reciprocite = norm(tr.querySelector("td:nth-child(6) select")?.value || "");
              const rang = norm(tr.querySelector("td:nth-child(7) input")?.value || "");

              if (!code_article && !code_equivalent && !type_equivalence && !reciprocite && !rang) return;
              rows.push({ code_article, libelle_article, code_equivalent, libelle_article_equivalent, type_equivalence, reciprocite, rang });
            });
          }

          const missing = rows.some((r) => !r.code_article || !r.code_equivalent || !r.type_equivalence || !r.reciprocite || !r.rang);
          if (rows.length === 0 || missing) {
            if (equivalenceFeedback) {
              equivalenceFeedback.textContent = "Veuillez renseigner au moins une ligne complète (code_article, code_equivalent, type_equivalence, reciprocite, rang).";
            }
            return;
          }

          const now = new Date();
          const dateStr = toIsoLocal(now);
          const requesterFirstname = norm(firstname.value);
          const requesterLastname = norm(lastname.value);
          const requester = `${requesterFirstname} ${requesterLastname}`.trim();
          const typeDemandeLabel = "Déclaration d'une équivalence";

          const subject = `[DDE MODIF ARTICLE] - Déclaration d'une équivalence - ${requester} - ${dateStr}`;

          const safeText = (v) => String(v || "").replace(/\s+/g, " ").trim();
          const to = "referentiel_logistique@tdf.fr";

          const tsv = [
            "code_article\tlibelle_article\tcode_equivalent\tlibelle_article_equivalent\ttype_equivalence\treciprocite\trang",
            ...rows.map((r) => [
              safeText(r.code_article),
              safeText(r.libelle_article),
              safeText(r.code_equivalent),
              safeText(r.libelle_article_equivalent),
              safeText(r.type_equivalence),
              safeText(r.reciprocite),
              safeText(r.rang),
            ].join("\t")),
          ].join("\n");

          let savedInfo = null;
          if (typeof API === "function") {
            try {
              if (equivalenceFeedback) {
                equivalenceFeedback.textContent = "Sauvegarde du fichier Excel sur le partage...";
              }
              const resp = await fetch(API("/downloads/demandes/equivalence_xlsx"), {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  date_demande: dateStr,
                  demandeur: requester,
                  type_demande: typeDemandeLabel,
                  rows: rows.map((r) => ({
                    code_article: safeText(r.code_article),
                    libelle_article: safeText(r.libelle_article),
                    code_equivalent: safeText(r.code_equivalent),
                    libelle_article_equivalent: safeText(r.libelle_article_equivalent),
                    type_equivalence: safeText(r.type_equivalence),
                    reciprocite: safeText(r.reciprocite),
                    rang: safeText(r.rang),
                  })),
                }),
              });
              const data = await resp.json().catch(() => null);
              if (resp.ok && data && data.ok) {
                savedInfo = data;
              } else {
                savedInfo = null;
              }
            } catch (e) {
              savedInfo = null;
            }
          }

          const pieceJointeLine = savedInfo && savedInfo.filename
            ? `Fichier Excel sauvegardé : ${savedInfo.filename}`
            : "Fichier Excel non sauvegardé (vérifier accès au partage \\\\apps\\... ).";

          const bodyText = [
            `Type de demande : ${typeDemandeLabel}`,
            `Prénom : ${requesterFirstname}`,
            `Nom : ${requesterLastname}`,
            `Date de la demande : ${dateStr}`,
            pieceJointeLine,
            "",
            tsv,
            "",
          ].join("\n");

          const MAILTO_URL_LIMIT = 1800;
          const fullUrl = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyText)}`;
          if (fullUrl.length > MAILTO_URL_LIMIT) {
            if (equivalenceFeedback) {
              equivalenceFeedback.textContent = "Le contenu est trop long pour être envoyé via mailto. Réduisez le nombre de lignes ou la longueur des champs.";
            }
            return;
          }

          if (equivalenceFeedback) {
            equivalenceFeedback.textContent = savedInfo && savedInfo.filename
              ? `Fichier Excel sauvegardé sur le partage : ${savedInfo.filename}. Ouverture du mail...`
              : "Impossible de sauvegarder le fichier Excel sur le partage. Ouverture du mail quand même.";
          }

          window.location.href = fullUrl;
        });
      }

      updateVisibility();
    });
  </script>
</body>
</html>
