<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>OL MODE DEGRADE V2</title>
  <link rel="stylesheet" href="css/style.css?v=2">
  <style>
    .help-tip {
      font-size: 0.85rem;
      max-width: 100%;
    }
    .help-tip-content {
      padding: 0.4rem 0.6rem;
      border-radius: 0.5rem;
    }
    .help-tip-text {
      line-height: 1.4;
    }
  </style>
  <script src="js/api.js?v=2" defer></script>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>
  <script src="js/ol_mode_degrade_v2.js?v=1" defer></script>
</head>
<body>
  <div id="scapp-header"></div>

  <div class="layout" style="font-size:1rem; grid-template-columns: 22vw minmax(0, 1fr);">
    <aside class="card">
      <h2 style="margin:0 0 8px; color:var(--muted)">OL MODE DEGRADE V2</h2>
      <form id="form-stock-map" class="section" onsubmit="return false;" style="display:flex; flex-direction:column; gap:0.75rem;">
        <div class="section" style="margin-bottom:0.25rem;">
          <label for="omd-type-commande" class="muted">Type de commande</label>
          <select id="omd-type-commande" style="width:100%; background:#ffffff; color:#111827;">
            <option value="STANDARD">STANDARD</option>
            <option value="URGENT">URGENT</option>
            <option value="MAD">MAD</option>
          </select>
          <div class="help-tip" style="margin-top:0.35rem;">
            <div class="help-tip-content">
              <div class="help-tip-text">
                <strong>Étape 1 :</strong> choisir le type de commande : STANDARD (livraison J+1 au départ de MPLC), URGENT (livraison aujourd'hui) ou MAD (le technicien se rend au magasin pour récupérer son matériel).
              </div>
            </div>
          </div>
        </div>

        <div class="section" style="margin-bottom:0.25rem;">
          <label for="omd-tech-select" class="muted">Technicien</label>
          <select id="omd-tech-select" style="width:100%; padding:10px 12px; border-radius:8px; border:1px solid #d1d5db; background:#ffffff; color:#111827;"></select>
          <div class="help-tip" style="margin-top:0.35rem;">
            <div class="help-tip-content">
              <div class="help-tip-text">
                <strong>Étape 2 :</strong> choisir le technicien concerné par l'ordre de livraison.
              </div>
            </div>
          </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:0.35rem;">
          <label class="muted" for="code_article">Code article (un ou plusieurs, séparés par des ";")</label>
          <input type="text" id="code_article" placeholder="Ex : TDF158545;TDF158548" required />
          <div id="code-article-help" class="help-tip">
            <div class="help-tip-content">
              <div class="help-tip-text">
                <strong>Étape 3 :</strong> saisir un ou plusieurs codes article en les séparant par un point-virgule ";".
              </div>
            </div>
          </div>
        </div>

        <div class="section" style="font-size:0.85rem; padding-top:0.5rem; display:flex; flex-direction:column; gap:0.75rem;">
          <div class="muted" style="margin-bottom:0.15rem;">
            Optionnel : renseigner un <strong>code IG</strong> ou une <strong>adresse postale</strong> pour positionner le centre de la carte
            et calculer la distance à vol d'oiseau entre chaque magasin et ce point.
          </div>

          <div style="display:flex; flex-direction:column; gap:0.25rem;">
            <label class="muted" for="code_ig">Code IG</label>
            <input type="text" id="code_ig" placeholder="Ex : FR12345" />
          </div>

          <div style="display:flex; flex-direction:column; gap:0.25rem;">
            <label class="muted" for="address">Adresse postale</label>
            <input type="text" id="address" placeholder="Ex : 100 rue ..., 75000 Paris" />
          </div>

          <div id="center-help" class="help-tip">
            <div class="help-tip-content">
              <div class="help-tip-text">
                <strong>Étape 4 :</strong> pour mieux calculer les distances, renseigner soit un <strong>code IG</strong>, soit une <strong>adresse postale</strong> de référence.
              </div>
            </div>
          </div>

          <div class="section" style="margin-top:0.5rem; padding-top:0.5rem; border-top:1px dashed var(--border);">
            <div class="muted" style="margin-bottom:0.25rem;">Filtres stock</div>

            <div style="margin-bottom:0.35rem;">
              <div class="muted" style="font-size:0.8rem; margin-bottom:0.15rem;">Type de dépôt</div>
              <div style="display:flex; flex-wrap:wrap; gap:0.2rem 0.75rem; font-size:0.8rem;">
                <label style="flex:0 0 48%;"><input type="checkbox" name="type_de_depot" value="NATIONAL" checked> NATIONAL</label>
                <label style="flex:0 0 48%;"><input type="checkbox" name="type_de_depot" value="LOCAL" checked> LOCAL</label>
                <label style="flex:0 0 48%;"><input type="checkbox" name="type_de_depot" value="REO" checked> REO</label>
                <label style="flex:0 0 48%;"><input type="checkbox" name="type_de_depot" value="PIED DE SITE" checked> PIED DE SITE</label>
                <label style="flex:0 0 48%;"><input type="checkbox" name="type_de_depot" value="EMBARQUE"> EMBARQUE</label>
              </div>
            </div>

            <div style="margin-bottom:0.35rem;">
              <div class="muted" style="font-size:0.8rem; margin-bottom:0.15rem;">Code qualité</div>
              <div style="display:flex; flex-wrap:wrap; gap:0.2rem 0.75rem; font-size:0.8rem;">
                <label style="flex:0 0 48%;"><input type="checkbox" name="code_qualite" value="GOOD" checked disabled> GOOD</label>
              </div>
            </div>

            <div>
              <div class="muted" style="font-size:0.8rem; margin-bottom:0.15rem;">Type de stock (flag_stock_d_m)</div>
              <div style="display:flex; flex-wrap:wrap; gap:0.2rem 0.75rem; font-size:0.8rem;">
                <label style="flex:0 0 48%;"><input type="checkbox" name="flag_stock_d_m" value="M" checked> M</label>
                <label style="flex:0 0 48%;"><input type="checkbox" name="flag_stock_d_m" value="D"> D</label>
              </div>
            </div>

            <div style="margin-top:0.5rem;">
              <div class="muted" style="font-size:0.8rem; margin-bottom:0.15rem;">Autres filtres</div>
              <div style="display:flex; flex-wrap:wrap; gap:0.2rem 0.75rem; font-size:0.8rem;">
                <label style="flex:0 0 100%;"><input type="checkbox" id="hors_transit" checked> HORS TRANSIT (exclure les materiels non réceptionnés par le magasin)</label>
              </div>
            </div>
          </div>
        </div>

        <button id="btn-search-stock-map" type="submit" style="margin-top:0.5rem;">Afficher sur la carte</button>
        <div id="search-help" class="help-tip">
          <div class="help-tip-content">
            <div class="help-tip-text">
              <strong>Étape 5 :</strong> cliquer sur « Afficher sur la carte » pour voir les stocks disponibles.
            </div>
          </div>
        </div>
        <div id="stock-map-status" class="muted"></div>
      </form>
      <div class="section">
        <div id="stock-map-article-info" class="muted" style="font-size:0.9rem;"></div>
        <div id="stock-map-center-info" class="muted" style="font-size:0.85rem; margin-top:0.35rem;"></div>
      </div>
    </aside>

    <main class="card">
      <div id="stock-map-panel" style="transition:max-height 0.4s ease, opacity 0.3s ease, transform 0.3s ease; overflow:hidden; max-height:2000px;">
        <div class="card" style="margin-bottom:1rem;">
          <h3 style="margin-top:0;">Carte des magasins avec stock (OL MODE DEGRADE V2)</h3>
          <div id="stock-map" style="height:600px; border-radius:0.5rem; overflow:hidden;"></div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
            <div>
              <div id="stock-map-count" class="muted"></div>
            </div>
            <div class="help-tip" style="margin-right:0.75rem;">
              <div class="help-tip-content">
                <div class="help-tip-text">
                  <strong>Étape 6 :</strong> pour le choix du magasin, privilégier un marker <strong>vert</strong> (tous les articles disponibles) et le plus proche du site de livraison, puis cliquer sur « Valider la sélection » pour générer le récapitulatif détaillé.
                </div>
              </div>
            </div>
            <button id="btn-validate-selection" type="button">Valider la sélection</button>
          </div>
          <div style="overflow:auto; max-height:35vh;">
            <table id="tbl-stock-map">
              <thead><tr id="stock-map-thead-row"></tr></thead>
              <tbody id="stock-map-tbody-rows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="section" style="display:flex; justify-content:flex-end; margin-top:0.5rem;">
        <button id="stock-map-toggle" type="button" style="font-size:0.85rem;">Replier la carte et les stocks</button>
      </div>

      <div id="stock-selection-summary" class="section" style="margin-top:0.75rem; background:linear-gradient(135deg, #e5f0ff 0%, #f5f7ff 40%, #ffffff 100%); border-radius:0.75rem; border:1px solid #2563eb; padding:0.75rem; color:#111827;"></div>

      <!-- Bloc de saisie OL (reprend les champs du panneau de gauche de ol_mode_degrade.html), structuré en 2 colonnes -->
      <div class="card" style="margin-top:1rem; background:linear-gradient(135deg, #e5f0ff 0%, #f5f7ff 40%, #ffffff 100%); color:#111827;">
        <div style="display:grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap:1.5rem; align-items:flex-start;">
          <!-- Colonne gauche : Informations OL + Technicien -->
          <div>
            <h2 style="margin-top:0; text-transform:uppercase; text-align:center; letter-spacing:0.05em;">Informations OL</h2>
            <div class="section">
              <div class="row" style="align-items:flex-end;">
                <div style="flex:1;">
                  <label for="omd-bt" class="muted">Numéro de BT</label>
                  <input type="text" id="omd-bt" style="width:100%; background:#ffffff; color:#111827;" />
                </div>
              </div>
              <div class="section" style="margin-top:0.5rem;">
                <label for="omd-date-besoin" class="muted">Date et heure de besoin</label>
                <input type="datetime-local" id="omd-date-besoin" style="width:100%; background:#ffffff; color:#111827;" />
              </div>
              <div class="section" style="margin-top:0.5rem;">
                <label for="omd-commentaire" class="muted">Commentaire libre</label>
                <textarea id="omd-commentaire" rows="2" style="width:100%; background:#ffffff; color:#111827;"></textarea>
              </div>
              <div class="section" style="margin-top:0.5rem;">
                <span class="muted">Adresse de livraison :</span>
                <div id="omd-dest-summary" style="font-size:0.85rem; margin-top:0.15rem;"></div>
              </div>
            </div>

            <div class="section">
              <h3 style="margin-top:0; font-size:0.95rem;">Technicien</h3>
              <!-- Détails du technicien -->
              <div style="margin-top:0.75rem;">
                <h3 style="margin-top:0; font-size:0.95rem;">Détails du technicien</h3>
                <table>
                  <tbody>
                    <tr><th style="text-align:left; width:200px;">Code magasin</th><td id="omd-code-magasin"></td></tr>
                    <tr><th style="text-align:left;">Libellé magasin</th><td id="omd-libelle-magasin"></td></tr>
                    <tr><th style="text-align:left;">Code tiers Daher</th><td id="omd-code-tiers"></td></tr>
                    <tr><th style="text-align:left;">Téléphone</th><td id="omd-telephone"></td></tr>
                    <tr><th style="text-align:left;">Email</th><td id="omd-email"></td></tr>
                    <tr><th style="text-align:left;">Adresse</th><td id="omd-adresse"></td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Colonne droite : Lieu de livraison + validation -->
          <div>
            <div class="section">
              <div style="margin-top:0.25rem; font-size:0.9rem; border:1px solid #2563eb; border-radius:8px; padding:0.75rem; background:#eff6ff;">
                <div class="muted" style="margin-bottom:0.25rem; font-weight:600; text-transform:uppercase; color:#111827;">Lieu de livraison</div>
                <div class="help-tip" style="margin-bottom:0.5rem;">
                  <div class="help-tip-content">
                    <div class="help-tip-text">
                      STANDARD : livraison sur le point relais du technicien. URGENT : adresse définie par code IG ou adresse libre. MAD : adresse de livraison = magasin(s) expéditeur(s).
                    </div>
                  </div>
                </div>
                <label style="display:block; margin-bottom:0.15rem; color:#111827;">
                  <input type="radio" name="omd-destination-type" value="code_ig" checked>
                  Code IG
                </label>
                <label style="display:block; margin-bottom:0.15rem; color:#111827;">
                  <input type="radio" name="omd-destination-type" value="point_relais">
                  Point relais
                </label>
                <label style="display:block; color:#111827;">
                  <input type="radio" name="omd-destination-type" value="adresse_libre">
                  Adresse libre
                </label>

                <div id="omd-dest-code-ig" style="margin-top:0.75rem;">
                  <label for="omd-code-ig" class="muted" style="color:#111827;">Code IG</label>
                  <input list="omd-code-ig-list" id="omd-code-ig" style="width:100%; max-width:100%; box-sizing:border-box; padding:10px 12px; border-radius:8px; border:1px solid #d1d5db; background:#ffffff; color:#111827;" />
                  <datalist id="omd-code-ig-list"></datalist>
                  <div id="omd-code-ig-address" class="muted" style="margin-top:0.25rem; font-size:0.8rem; color:#111827;"></div>
                </div>

                <div id="omd-dest-pr" style="margin-top:0.75rem; display:none;">
                  <div class="muted" style="margin-bottom:0.25rem; color:#111827;">Point relais</div>
                  <label style="display:block; margin-bottom:0.15rem; color:#111827;">
                    <input type="radio" name="omd-pr-choice" value="principal" checked>
                    Utiliser le point relais principal
                  </label>
                  <label style="display:block; color:#111827;">
                    <input type="radio" name="omd-pr-choice" value="hors_normes">
                    Utiliser le point relais hors normes
                  </label>
                  <div id="omd-dest-pr-address" class="muted" style="margin-top:0.5rem; font-size:0.85rem; color:#111827;"></div>
                </div>

                <div id="omd-dest-free" style="margin-top:0.75rem; display:none;">
                  <div class="muted" style="margin-bottom:0.25rem; color:#111827;">Adresse libre</div>
                  <div class="section" style="margin-top:0;">
                    <label for="omd-free-raison" class="muted" style="color:#111827;">Raison sociale</label>
                    <input type="text" id="omd-free-raison" style="width:100%; background:#ffffff; color:#111827;" />
                  </div>
                  <div class="section" style="margin-top:0.5rem;">
                    <label for="omd-free-l1" class="muted" style="color:#111827;">Adresse (ligne 1)</label>
                    <input type="text" id="omd-free-l1" style="width:100%; background:#ffffff; color:#111827;" />
                  </div>
                  <div class="section" style="margin-top:0.5rem;">
                    <label for="omd-free-l2" class="muted" style="color:#111827;">Adresse (ligne 2)</label>
                    <input type="text" id="omd-free-l2" style="width:100%; background:#ffffff; color:#111827;" />
                  </div>
                  <div class="section" style="margin-top:0.5rem; display:flex; gap:0.5rem;">
                    <div style="width:40%;">
                      <label for="omd-free-cp" class="muted" style="color:#111827;">Code postal</label>
                      <input type="text" id="omd-free-cp" style="width:100%; background:#ffffff; color:#111827;" />
                    </div>
                    <div style="flex:1;">
                      <label for="omd-free-ville" class="muted" style="color:#111827;">Ville</label>
                      <input type="text" id="omd-free-ville" style="width:100%; background:#ffffff; color:#111827;" />
                    </div>
                  </div>
                </div>
            <div class="section" style="display:flex; justify-content:flex-end; align-items:center; gap:0.75rem; margin-top:0.75rem;">
              <div id="omd-v2-status" class="muted" style="flex:1;"></div>
              <div class="help-tip" style="margin-right:0.75rem;">
                <div class="help-tip-content">
                  <div class="help-tip-text">
                    <strong>Étape 7 :</strong> une fois le récapitulatif vérifié, cliquer sur « Valider l'ordre de livraison (V2) » pour finaliser l'OL.
                  </div>
                </div>
              </div>
              <button id="omd-v2-validate" type="button">Valider l'ordre de livraison (V2)</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</body>
</html>
